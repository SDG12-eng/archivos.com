<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArchiveMaster Enterprise</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root { --primary: #2563eb; --primary-hover: #1d4ed8; --sidebar-width: 260px; --bg-app: #f4f7f9; --text-main: #334155; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-app); color: var(--text-main); overflow-x: hidden; }
        
        /* Utilidades */
        .pointer { cursor: pointer; } 
        .hover-scale:hover { transform: scale(1.03); transition: transform 0.2s; }
        ::-webkit-scrollbar { width: 6px; height: 6px; } 
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .scroll-y { max-height: 60vh; overflow-y: auto; }

        /* Sidebar & Layout */
        #sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background-color: #0f172a; color: #f8fafc; z-index: 1000; transition: all 0.3s ease; display: flex; flex-direction: column; }
        #main-content { margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column; background-color: var(--bg-app); }
        
        .nav-link-menu { padding: 14px 20px; margin: 4px 16px; border-radius: 12px; color: #94a3b8; font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 14px; text-decoration: none; transition: all 0.2s; }
        .nav-link-menu:hover, .nav-link-menu.active { background: rgba(255,255,255,0.08); color: #fff; }
        .nav-link-menu.active { background: var(--primary); box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); color: white; }

        /* UI Cards & Buttons */
        .card-panel { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03); }
        .card-header-panel { background: transparent; border-bottom: 1px solid #f1f5f9; padding: 20px 24px; font-weight: 800; font-size: 1.1rem; color: #1e293b; }
        .btn-brand { background-color: var(--primary); color: white; font-weight: 700; border-radius: 10px; border: none; padding: 12px 24px; transition: all 0.3s; }
        .btn-brand:hover { background-color: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 8px 15px rgba(37,99,235,0.25); color: white; }
        
        /* Formularios */
        .form-control, .form-select { border-radius: 10px; padding: 0.75rem 1rem; border: 1px solid #cbd5e1; background-color: #f8fafc; font-size: 0.95rem; font-weight: 500; }
        .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(37,99,235,0.1); background-color: #fff; }
        
        /* Etiquetas de Estado */
        .status-badge { padding: 6px 14px; border-radius: 20px; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .bg-st-pendiente { background-color: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .bg-st-aprobado { background-color: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
        .bg-st-rechazado { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
        .bg-st-registrado { background-color: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }

        /* Pestañas (Tabs) Admin */
        .admin-tabs .nav-link { color: #64748b; font-weight: 700; border-radius: 10px; padding: 12px 24px; transition: all 0.2s; border: 1px solid transparent; }
        .admin-tabs .nav-link:hover { background-color: #f1f5f9; color: var(--primary); }
        .admin-tabs .nav-link.active { background-color: var(--primary); color: white; box-shadow: 0 4px 10px rgba(37,99,235,0.2); }

        /* Grilla Tipo Excel */
        .grid-table th { background: #f1f5f9; font-size: 0.8rem; text-transform: uppercase; color: #64748b; font-weight: 800; }
        .grid-input { border: none; background: transparent; width: 100%; padding: 10px; font-weight: 600; color: #1e293b; outline: none; }
        .grid-input:focus { background-color: #eff6ff; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="toast-container position-fixed bottom-0 end-0 p-4" style="z-index: 2000;" id="toast-container"></div>

    <div id="login-screen" class="vh-100 d-flex justify-content-center align-items-center" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
        <div class="card-panel p-5 border-0 shadow-lg" style="width: 400px; background: rgba(255,255,255,0.98);">
            <div class="text-center mb-4">
                <i class="bi bi-layers-fill fs-1 text-primary"></i>
                <h3 class="fw-black mt-2 text-dark">ArchiveMaster</h3>
                <span class="badge bg-primary bg-opacity-10 text-primary fw-bold letter-spacing-1">ENTERPRISE</span>
            </div>
            <form id="login-form">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="login-user" placeholder="Usuario" required>
                    <label>ID de Usuario</label>
                </div>
                <div class="form-floating mb-4">
                    <input type="password" class="form-control" id="login-pass" placeholder="Contraseña" required>
                    <label>Contraseña</label>
                </div>
                <button type="submit" class="btn-brand w-100 py-3 fs-6">Ingresar al Sistema</button>
            </form>
        </div>
    </div>

    <div id="app-screen" class="d-none">
        
        <aside id="sidebar" class="shadow-lg">
            <div class="p-4 d-flex align-items-center gap-3 border-bottom border-secondary border-opacity-25">
                <i class="bi bi-layers-half text-primary fs-2"></i>
                <div>
                    <h5 class="mb-0 fw-bold">ArchiveMaster</h5>
                    <small class="text-primary fw-bold" style="font-size: 0.7rem;">PRO PLATINUM</small>
                </div>
            </div>
            
            <div class="p-4">
                <div class="d-flex align-items-center gap-3 p-3 rounded-4" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                    <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center fw-bold fs-5" style="width: 45px; height: 45px;" id="avatar-initial"></div>
                    <div style="line-height: 1.2;">
                        <h6 class="mb-1 fw-bold text-white" id="user-display">User</h6>
                        <span class="badge bg-info bg-opacity-25 text-info" id="role-display" style="font-size: 0.65rem;">ROL</span>
                    </div>
                </div>
            </div>

            <nav id="menu-dinamico" class="mt-2 flex-grow-1 scroll-y"></nav>

            <div class="p-4 mt-auto border-top border-secondary border-opacity-25">
                <button class="btn w-100 text-start fw-bold rounded-3 p-3 hover-scale" id="btn-logout" style="background: rgba(239, 68, 68, 0.1); color: #f87171;">
                    <i class="bi bi-power me-2"></i> Cerrar Sesión
                </button>
            </div>
        </aside>

        <main id="main-content">
            
            <header class="bg-white py-3 px-4 d-flex justify-content-between align-items-center sticky-top border-bottom shadow-sm" style="z-index: 900;">
                <h4 class="mb-0 fw-bold text-dark" id="section-title">Dashboard</h4>
                <div class="text-muted small fw-bold bg-light px-3 py-2 rounded-pill border" id="datetime-display"></div>
            </header>

            <div class="container-fluid p-4">
                
                <div id="sec-dashboard" class="content-section d-none fade-in">
                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <div class="card-panel p-4 d-flex align-items-center gap-4">
                                <div class="bg-primary bg-opacity-10 p-4 rounded-circle text-primary"><i class="bi bi-hdd-stack fs-1"></i></div>
                                <div><small class="text-muted fw-bold text-uppercase">Total Registros</small><h2 class="fw-black mb-0" id="dash-total">0</h2></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card-panel p-4 d-flex align-items-center gap-4">
                                <div class="bg-warning bg-opacity-10 p-4 rounded-circle text-warning"><i class="bi bi-inbox fs-1"></i></div>
                                <div><small class="text-muted fw-bold text-uppercase">Tareas Pendientes</small><h2 class="fw-black mb-0" id="dash-tasks">0</h2></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sec-registrar" class="content-section d-none fade-in">
                    <div class="card-panel mx-auto shadow-sm" style="max-width: 900px;">
                        <div class="card-header-panel bg-light rounded-top-4">
                            <i class="bi bi-journal-plus text-primary me-2"></i> Captura de Datos
                        </div>
                        <div class="card-body p-4 p-md-5">
                            <label class="form-label small fw-bold text-muted text-uppercase mb-2">Seleccione el Formulario / Plantilla</label>
                            <select id="reg-template-select" class="form-select form-select-lg mb-4 fw-bold text-primary shadow-sm border-primary"></select>
                            
                            <form id="dynamic-form" class="d-none">
                                <input type="hidden" id="current-tpl-type">
                                
                                <div id="standard-fields-container" class="row g-4 mb-4"></div>
                                
                                <div id="grid-container" class="d-none mb-4">
                                    <div class="table-responsive border rounded-3 overflow-hidden">
                                        <table class="table grid-table mb-0 bg-white" id="grid-table">
                                            <thead id="grid-header"></thead>
                                            <tbody id="grid-body"></tbody>
                                        </table>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-3 fw-bold px-4 py-2" id="btn-add-row">
                                        <i class="bi bi-plus-lg me-1"></i> Añadir Fila
                                    </button>
                                </div>

                                <div class="bg-light p-4 rounded-4 border mb-4">
                                    <label class="small fw-bold text-dark mb-2"><i class="bi bi-paperclip text-primary"></i> Archivo Adjunto (Opcional)</label>
                                    <input type="file" id="reg-file" class="form-control bg-white">
                                </div>

                                <div id="dynamic-flow-section" class="d-none bg-primary bg-opacity-10 border border-primary border-opacity-25 rounded-4 p-4 mb-5 shadow-sm">
                                    <h6 class="fw-bold text-primary mb-3"><i class="bi bi-diagram-3-fill me-2"></i> Asignación de Flujo Requerida</h6>
                                    <p class="small text-muted mb-4" id="dynamic-flow-desc">Debe asignar un responsable para continuar.</p>
                                    <div class="row g-3">
                                        <div class="col-md-5">
                                            <label class="form-label small fw-bold text-dark" id="dynamic-flow-label">Asignar A:</label>
                                            <select id="dyn-flow-user" class="form-select border-primary" required></select>
                                        </div>
                                        <div class="col-md-3 d-none" id="dyn-flow-priority-container">
                                            <label class="form-label small fw-bold text-dark">Prioridad:</label>
                                            <select id="dyn-flow-priority" class="form-select border-primary">
                                                <option value="baja">Baja</option>
                                                <option value="media" selected>Media</option>
                                                <option value="alta">Alta</option>
                                            </select>
                                        </div>
                                        <div class="col-md-12 d-none" id="dyn-flow-reason-container">
                                            <label class="form-label small fw-bold text-dark">Instrucciones / Motivo:</label>
                                            <input type="text" id="dyn-flow-reason" class="form-control border-primary" placeholder="Ej. Por favor revisar el stock crítico adjunto.">
                                        </div>
                                    </div>
                                </div>

                                <div class="text-end border-top pt-4">
                                    <button type="submit" class="btn-brand px-5 shadow"><i class="bi bi-send-check-fill me-2"></i> PROCESAR Y ENVIAR</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="sec-mistareas" class="content-section d-none fade-in">
                    <div class="card-panel">
                        <div class="card-header-panel bg-light"><i class="bi bi-inbox-fill text-primary me-2"></i> Mi Bandeja de Tareas y Revisiones</div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-white text-uppercase small text-muted border-bottom"><tr><th class="ps-4">Prioridad</th><th>Tarea / Motivo</th><th>Asignado El</th><th>Estado</th><th>Acción</th></tr></thead>
                                    <tbody id="body-mistareas"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sec-historial" class="content-section d-none fade-in">
                    <div class="card-panel">
                        <div class="card-header-panel d-flex justify-content-between align-items-center bg-light">
                            <span><i class="bi bi-database-fill-gear text-primary me-2"></i> Master Data Global</span>
                            <button class="btn btn-dark btn-sm fw-bold px-3 rounded-pill shadow-sm" onclick="exportarTabla('table-global', 'MasterData_Export')">
                                <i class="bi bi-file-earmark-excel-fill me-1"></i> Exportar a Excel
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive scroll-y">
                                <table class="table table-hover align-middle mb-0" id="table-global">
                                    <thead class="bg-white text-muted small text-uppercase sticky-top shadow-sm"><tr><th class="ps-4">Fecha</th><th>Tipo</th><th>Formulario Base</th><th>Grupo</th><th>Responsable/Flujo</th><th>Estado Actual</th><th>Gestión</th></tr></thead>
                                    <tbody id="body-global"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sec-admin" class="content-section d-none fade-in">
                    
                    <ul class="nav nav-pills mb-4 admin-tabs bg-white p-2 rounded-4 shadow-sm border d-inline-flex" id="adminTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-tpls-btn" data-bs-toggle="pill" data-bs-target="#tab-tpls" type="button" role="tab" aria-controls="tab-tpls" aria-selected="true">
                                <i class="bi bi-layout-text-window-reverse me-2"></i>1. Diseño & Flujos
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-users-btn" data-bs-toggle="pill" data-bs-target="#tab-users" type="button" role="tab" aria-controls="tab-users" aria-selected="false">
                                <i class="bi bi-people-fill me-2"></i>2. Accesos y Usuarios
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-groups-btn" data-bs-toggle="pill" data-bs-target="#tab-groups" type="button" role="tab" aria-controls="tab-groups" aria-selected="false">
                                <i class="bi bi-diagram-3-fill me-2"></i>3. Departamentos
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="adminTabsContent">
                        
                        <div class="tab-pane fade show active" id="tab-tpls" role="tabpanel" aria-labelledby="tab-tpls-btn">
                            <div class="row g-4">
                                <div class="col-lg-7">
                                    <div class="card-panel h-100">
                                        <div class="card-body p-4 p-lg-5">
                                            <h5 class="fw-bold text-dark mb-4"><i class="bi bi-tools text-primary me-2"></i> Creador de Formularios</h5>
                                            
                                            <div class="row g-3 mb-4">
                                                <div class="col-md-12">
                                                    <input type="text" id="tpl-name" class="form-control form-control-lg fw-bold" placeholder="Nombre del Formulario (Ej. Control de Calidad)">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="small fw-bold text-muted mb-1">Estructura Base</label>
                                                    <select id="tpl-type" class="form-select fw-bold">
                                                        <option value="formulario">Formulario Estándar</option>
                                                        <option value="inventario">Módulo de Inventario (Fijo)</option>
                                                        <option value="excel">Grilla Dinámica (Tipo Excel)</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="small fw-bold text-muted mb-1">Grupo Propietario</label>
                                                    <select id="tpl-group" class="form-select fw-bold"><option value="">- Seleccionar Grupo -</option></select>
                                                </div>
                                            </div>
                                            
                                            <div id="custom-fields-section" class="bg-light border rounded-4 p-4 mb-4">
                                                <h6 class="fw-bold small text-muted text-uppercase mb-3">Campos Personalizados</h6>
                                                <div class="d-flex gap-2 mb-3">
                                                    <input type="text" id="field-name" class="form-control" placeholder="Nombre de Pregunta/Columna">
                                                    <select id="field-type" class="form-select" style="max-width: 150px;">
                                                        <option value="text">Texto Corto</option>
                                                        <option value="number">Número</option>
                                                        <option value="date">Fecha</option>
                                                        <option value="select">Lista Múltiple</option>
                                                        <option value="textarea">Texto Largo</option>
                                                    </select>
                                                    <button type="button" class="btn btn-dark px-4 rounded-3" id="btn-add-field"><i class="bi bi-plus-lg"></i></button>
                                                </div>
                                                <input type="text" id="field-options" class="form-control mb-3 d-none" placeholder="Opciones separadas por coma (ej. Opción A, Opción B)">
                                                <div id="builder-fields-container" class="d-flex flex-wrap gap-2 mt-2"></div>
                                            </div>

                                            <div class="bg-primary bg-opacity-10 border border-primary border-opacity-25 rounded-4 p-4 mb-4">
                                                <h6 class="fw-bold text-primary mb-3"><i class="bi bi-diagram-3-fill me-2"></i> Flujo Post-Registro</h6>
                                                <select id="flow-type" class="form-select mb-3 fw-bold border-primary">
                                                    <option value="solo_registro">Finalizar (Solo guardar datos en Master Data)</option>
                                                    <option value="aprobacion">El Registro requiere Aprobación</option>
                                                    <option value="tarea">Generar una Tarea de Seguimiento</option>
                                                </select>
                                                
                                                <div id="flow-config-details" class="d-none bg-white p-3 rounded-3 border mt-3">
                                                    <label class="small fw-bold text-dark mb-2">Asignación del Responsable:</label>
                                                    <select id="flow-assignment-type" class="form-select mb-3">
                                                        <option value="dinamico">El Usuario elige a quién enviarlo al llenar los datos.</option>
                                                        <option value="fijo">Asignación Fija (Siempre a la misma persona).</option>
                                                    </select>
                                                    <div id="flow-fixed-user-container" class="d-none">
                                                        <select id="flow-fixed-user" class="form-select"><option value="">- Seleccione Usuario -</option></select>
                                                    </div>
                                                </div>
                                            </div>

                                            <button type="button" class="btn-brand w-100 py-3 shadow" id="btn-save-tpl">PUBLICAR FORMULARIO</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="card-panel h-100 scroll-y">
                                        <div class="card-header-panel bg-light">Catálogo Activo</div>
                                        <div class="card-body p-0">
                                            <ul id="list-templates" class="list-group list-group-flush"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-users" role="tabpanel" aria-labelledby="tab-users-btn">
                            <div class="row g-4">
                                <div class="col-lg-5">
                                    <div class="card-panel h-100">
                                        <div class="card-header-panel bg-light"><i class="bi bi-person-badge-fill text-primary me-2"></i> Ficha de Usuario</div>
                                        <div class="card-body p-4">
                                            <form id="form-user">
                                                <div class="row g-3 mb-4">
                                                    <div class="col-12"><input type="text" id="usr-id" class="form-control fw-bold" placeholder="ID (Ej. mperez)" required></div>
                                                    <div class="col-12"><input type="password" id="usr-pass" class="form-control" placeholder="Contraseña de Acceso" required></div>
                                                    <div class="col-12">
                                                        <select id="usr-rol" class="form-select fw-bold">
                                                            <option value="usuario">Nivel: Usuario Regular</option>
                                                            <option value="revisor">Nivel: Supervisor / Revisor</option>
                                                            <option value="admin">Nivel: Administrador Total</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-4">
                                                    <label class="fw-bold small text-dark mb-3 text-uppercase border-bottom pb-2 d-block">Asignación a Departamentos</label>
                                                    <div id="usr-groups-container" class="row g-2 px-1"></div>
                                                </div>
                                                
                                                <div class="mb-4 bg-light p-3 rounded-4 border">
                                                    <label class="fw-bold small text-dark mb-2 d-block">Visibilidad de Pestañas</label>
                                                    <div class="d-flex flex-wrap gap-3">
                                                        <div class="form-check"><input class="form-check-input perm-chk" type="checkbox" value="dashboard" id="p-dash" checked><label class="form-check-label small" for="p-dash">Dash</label></div>
                                                        <div class="form-check"><input class="form-check-input perm-chk" type="checkbox" value="registrar" id="p-reg" checked><label class="form-check-label small" for="p-reg">Registrar</label></div>
                                                        <div class="form-check"><input class="form-check-input perm-chk" type="checkbox" value="mistareas" id="p-task" checked><label class="form-check-label small" for="p-task">Tareas</label></div>
                                                        <div class="form-check"><input class="form-check-input perm-chk" type="checkbox" value="historial" id="p-hist"><label class="form-check-label small" for="p-hist">MasterData</label></div>
                                                        <div class="form-check"><input class="form-check-input perm-chk" type="checkbox" value="admin" id="p-adm"><label class="form-check-label small" for="p-adm">Admin</label></div>
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-dark w-100 py-3 rounded-3 fw-bold">Guardar Usuario</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-7">
                                     <div class="card-panel h-100 scroll-y">
                                        <div class="card-header-panel bg-light">Directorio Activo</div>
                                        <div class="card-body p-0"><ul id="list-users" class="list-group list-group-flush"></ul></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-groups" role="tabpanel" aria-labelledby="tab-groups-btn">
                            <div class="row g-4">
                                <div class="col-md-5">
                                    <div class="card-panel h-100">
                                        <div class="card-header-panel bg-dark text-white"><i class="bi bi-diagram-2-fill me-2"></i> Nuevo Departamento</div>
                                        <div class="card-body p-4">
                                            <form id="form-group">
                                                <div class="mb-3"><input type="text" id="grp-id" class="form-control fw-bold" placeholder="ID Corto (Ej. g_ventas)" required></div>
                                                <div class="mb-4"><input type="text" id="grp-name" class="form-control" placeholder="Nombre Público (Ej. Gerencia de Ventas)" required></div>
                                                <button type="submit" class="btn-brand w-100 py-2">Crear Departamento</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <div class="card-panel h-100 scroll-y">
                                        <div class="card-header-panel bg-light">Departamentos Existentes</div>
                                        <div class="card-body p-0"><ul id="list-groups" class="list-group list-group-flush"></ul></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, updateDoc, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        
        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = { apiKey: "AIzaSyA3cRmakg2dV2YRuNV1fY7LE87artsLmB8", authDomain: "mi-web-db.firebaseapp.com", projectId: "mi-web-db", storageBucket: "mi-web-db.appspot.com" };
        const app = initializeApp(firebaseConfig); 
        const db = getFirestore(app);

        // --- ESTADO GLOBAL ---
        let currentUser = null; 
        let tempFields = []; 
        let gridColumns = []; 
        let cache = { templates: [], groups: [], users: [] };
        
        // Helpers Cortos
        const el = (id) => document.getElementById(id);
        const showToast = (msg, type = 'success') => {
            const container = el('toast-container');
            const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
            container.innerHTML += `<div class="toast show align-items-center text-bg-${type} border-0 p-2 mb-2 shadow-lg rounded-3"><div class="d-flex"><div class="toast-body fw-bold"><i class="bi bi-${icon}-fill me-2 fs-5"></i>${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
            setTimeout(() => { if(container.firstChild) container.firstChild.remove(); }, 3500);
        };

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            setInterval(() => { el('datetime-display').innerText = new Date().toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' }); }, 1000);
            const session = localStorage.getItem("am_enterprise_session"); 
            if(session) initApp(JSON.parse(session));
            setupEventListeners();
        });

        // --- MANEJADORES DE EVENTOS GLOBALES ---
        function setupEventListeners() {
            // Login
            el('login-form').addEventListener('submit', async e => {
                e.preventDefault();
                const u = el('login-user').value.trim().toLowerCase(), p = el('login-pass').value.trim();
                if(u === "admin" && p === "1130"){ initApp({id: "admin", rol: "admin", accesos: ["dashboard", "registrar", "mistareas", "historial", "admin"], grupos: []}); return; }
                try { 
                    const s = await getDoc(doc(db, "am_usuarios", u)); 
                    if(s.exists() && s.data().pass === p) initApp({id: u, ...s.data()}); 
                    else showToast("Credenciales inválidas", "danger"); 
                } catch(err) { showToast("Error de conexión", "danger"); }
            });

            // Logout
            el('btn-logout').addEventListener('click', () => {
                localStorage.removeItem("am_enterprise_session"); location.reload();
            });

            // UI del Constructor (Mostrar input de opciones)
            el('field-type').addEventListener('change', e => {
                el('field-options').classList.toggle('d-none', e.target.value !== 'select');
            });

            // UI del Constructor (Manejo de Tipo Inventario vs Campos Custom)
            el('tpl-type').addEventListener('change', e => {
                const isInventario = e.target.value === 'inventario';
                el('custom-fields-section').classList.toggle('d-none', isInventario);
                if (isInventario) {
                    // Pre-llenar campos estáticos para inventario
                    tempFields = [
                        { name: 'Código/Item', type: 'text' },
                        { name: 'Operación', type: 'select', options: ['ENTRADA', 'SALIDA', 'AJUSTE'] },
                        { name: 'Cantidad', type: 'number' },
                        { name: 'Observación', type: 'text' }
                    ];
                    renderBuilderFields();
                } else {
                    tempFields = []; renderBuilderFields();
                }
            });

            // Añadir Campo al Constructor
            el('btn-add-field').addEventListener('click', () => {
                const n = el('field-name').value.trim(), t = el('field-type').value, o = el('field-options').value.trim();
                if(!n) return;
                tempFields.push({name: n, type: t, options: t === 'select' ? o.split(',').map(x => x.trim()) : []});
                renderBuilderFields();
                el('field-name').value = ''; el('field-options').value = '';
            });

            // UI de Configuración de Flujo
            el('flow-type').addEventListener('change', e => {
                el('flow-config-details').classList.toggle('d-none', e.target.value === 'solo_registro');
            });
            el('flow-assignment-type').addEventListener('change', e => {
                el('flow-fixed-user-container').classList.toggle('d-none', e.target.value === 'dinamico');
            });

            // Guardar Plantilla
            el('btn-save-tpl').addEventListener('click', async () => {
                const nom = el('tpl-name').value.trim(), tipo = el('tpl-type').value, grp = el('tpl-group').value;
                const flowT = el('flow-type').value, assignT = el('flow-assignment-type').value, fixedU = el('flow-fixed-user').value;
                
                if(!nom || !grp || tempFields.length === 0) return showToast("Falta nombre, grupo o campos", "warning");
                if(flowT !== 'solo_registro' && assignT === 'fijo' && !fixedU) return showToast("Elija al responsable fijo", "warning");

                const flujoConfig = { tipo: flowT, asignacion: assignT, usuarioFijo: fixedU };
                await addDoc(collection(db, "am_plantillas"), { nombre: nom, tipo, grupoId: grp, campos: tempFields, flujoConfig, timestamp: Date.now() });
                
                showToast("Formulario Creado y Publicado"); 
                el('tpl-name').value = ''; tempFields = []; renderBuilderFields();
                if (tipo === 'inventario') { el('tpl-type').value = 'formulario'; el('custom-fields-section').classList.remove('d-none'); }
            });

            // Guardar Usuario
            el('form-user').addEventListener('submit', async e => {
                e.preventDefault();
                const id = el('usr-id').value.trim().toLowerCase(), pass = el('usr-pass').value.trim();
                let acc = [], grps = [];
                document.querySelectorAll('.perm-chk:checked').forEach(c => acc.push(c.value));
                document.querySelectorAll('.grp-chk:checked').forEach(c => grps.push(c.value));
                await setDoc(doc(db, "am_usuarios", id), { pass, rol: el('usr-rol').value, accesos: acc, grupos: grps }, { merge: true });
                showToast("Ficha de usuario guardada"); e.target.reset();
            });

            // Guardar Grupo
            el('form-group').addEventListener('submit', async e => {
                e.preventDefault();
                await setDoc(doc(db, "am_grupos", el('grp-id').value.trim()), { nombre: el('grp-name').value.trim() });
                showToast("Departamento creado"); e.target.reset();
            });

            // Cambiar Pestaña (Formulario de Registro)
            el('reg-template-select').addEventListener('change', renderizarFormularioDinamico);
            
            // Añadir fila a grilla
            el('btn-add-row').addEventListener('click', agregarFilaGrilla);

            // Enviar Registro (Captura de Datos)
            el('dynamic-form').addEventListener('submit', procesarRegistro);
        }

        function renderBuilderFields() {
            el('builder-fields-container').innerHTML = tempFields.map((f, i) => `<span class="badge bg-white border border-secondary text-dark p-2 rounded-pill shadow-sm"><i class="bi bi-tag-fill me-1 text-primary"></i>${f.name} <i class="bi bi-x-circle-fill text-danger pointer ms-2 hover-scale" onclick="window.removerCampoTemp(${i})"></i></span>`).join('');
        }
        window.removerCampoTemp = (index) => { tempFields.splice(index, 1); renderBuilderFields(); };

        // --- ARRANQUE DE APP ---
        function initApp(u) { 
            currentUser = u; 
            el('login-screen').classList.add("d-none"); el('app-screen').classList.remove("d-none"); 
            el('user-display').innerText = u.id; el('role-display').innerText = u.rol.toUpperCase(); 
            el('avatar-initial').innerText = u.id[0].toUpperCase(); 
            
            const navMap = { dashboard: {id: 'sec-dashboard', n: 'Dashboard', i: 'pie-chart-fill'}, registrar: {id: 'sec-registrar', n: 'Realizar Registro', i: 'journal-plus'}, mistareas: {id: 'sec-mistareas', n: 'Bandeja de Tareas', i: 'inbox-fill'}, historial: {id: 'sec-historial', n: 'Master Data Global', i: 'database-fill'}, admin: {id: 'sec-admin', n: 'Ajustes del Sistema', i: 'sliders'} }; 
            el('menu-dinamico').innerHTML = u.accesos.map(a => navMap[a] ? `<a href="#" class="nav-link-menu" id="nav-${a}" onclick="window.navigateTo('${a}')"><i class="bi bi-${navMap[a].i} fs-5"></i><span>${navMap[a].n}</span></a>` : '').join(''); 
            
            if(u.accesos.length > 0) window.navigateTo(u.accesos[0]); 
            startRealtimeListeners(); 
        }

        window.navigateTo = (sId) => { 
            document.querySelectorAll(".content-section").forEach(e => e.classList.add("d-none")); 
            document.querySelectorAll(".nav-link-menu").forEach(e => e.classList.remove("active")); 
            const section = el(navMapHelper(sId).id);
            if(section) {
                section.classList.remove("d-none"); 
                el(`nav-${sId}`)?.classList.add("active"); 
                el("section-title").innerText = navMapHelper(sId).n; 
            }
        };
        const navMapHelper = (sId) => ({ dashboard: {id: 'sec-dashboard', n: 'Dashboard'}, registrar: {id: 'sec-registrar', n: 'Realizar Registro'}, mistareas: {id: 'sec-mistareas', n: 'Bandeja de Tareas'}, historial: {id: 'sec-historial', n: 'Master Data Global'}, admin: {id: 'sec-admin', n: 'Ajustes del Sistema'} }[sId]);

        // --- LÓGICA DE RENDERIZADO DE REGISTRO ---
        function renderizarFormularioDinamico(e) {
            const tplId = e.target.value; const form = el('dynamic-form');
            if(!tplId) { form.classList.add('d-none'); return; } 
            
            form.classList.remove('d-none');
            const tpl = cache.templates.find(t => t.id === tplId); 
            el('current-tpl-type').value = tpl.tipo; gridColumns = tpl.campos;
            
            const stdContainer = el('standard-fields-container'), gridContainer = el('grid-container');
            
            if(tpl.tipo === 'formulario' || tpl.tipo === 'inventario') {
                gridContainer.classList.add('d-none'); 
                stdContainer.innerHTML = tpl.campos.map(c => `
                    <div class="${c.type === 'textarea' ? 'col-12' : 'col-md-6'}">
                        <label class="form-label small fw-bold text-dark">${c.name}</label>
                        ${c.type === 'textarea' ? `<textarea class="form-control dyn-field" data-name="${c.name}" required></textarea>` : (c.type === 'select' ? `<select class="form-select dyn-field border-primary" data-name="${c.name}" required><option value="">- Seleccionar -</option>${c.options.map(o => `<option>${o}</option>`).join('')}</select>` : `<input type="${c.type}" class="form-control dyn-field" data-name="${c.name}" required>`)}
                    </div>`).join('');
            } else { 
                stdContainer.innerHTML = ''; gridContainer.classList.remove('d-none'); 
                el('grid-header').innerHTML = `<tr>${tpl.campos.map(c => `<th class="fw-bold">${c.name}</th>`).join('')}<th width="40"></th></tr>`; 
                el('grid-body').innerHTML = ''; agregarFilaGrilla(); 
            }

            // Flujo
            const flowSec = el('dynamic-flow-section');
            if (tpl.flujoConfig.tipo !== 'solo_registro' && tpl.flujoConfig.asignacion === 'dinamico') {
                flowSec.classList.remove('d-none');
                el('dyn-flow-user').innerHTML = '<option value="">- Elegir Responsable -</option>' + cache.users.map(u => `<option value="${u.id}">${u.id} (${u.rol})</option>`).join('');
                el('dyn-flow-user').required = true;

                if (tpl.flujoConfig.tipo === 'tarea') {
                    el('dynamic-flow-desc').innerText = "Configure a quién se le asignará la tarea de ejecución.";
                    el('dynamic-flow-label').innerText = "Asignar Tarea A:";
                    el('dyn-flow-priority-container').classList.remove('d-none');
                    el('dyn-flow-reason-container').classList.remove('d-none');
                } else {
                    el('dynamic-flow-desc').innerText = "Seleccione a la persona que deberá revisar y aprobar este registro.";
                    el('dynamic-flow-label').innerText = "Enviar para Aprobación a:";
                    el('dyn-flow-priority-container').classList.add('d-none');
                    el('dyn-flow-reason-container').classList.add('d-none');
                }
            } else { 
                flowSec.classList.add('d-none'); el('dyn-flow-user').required = false; 
            }
        }

        function agregarFilaGrilla() { 
            el('grid-body').insertAdjacentHTML('beforeend', `<tr>${gridColumns.map(c => `<td><input type="${c.type === 'number' ? 'number' : 'text'}" class="grid-input" data-col="${c.name}" placeholder="..."></td>`).join('')}<td class="text-center align-middle"><i class="bi bi-x-circle-fill text-danger pointer fs-5 hover-scale" onclick="this.closest('tr').remove()"></i></td></tr>`); 
        }

        async function procesarRegistro(e) { 
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]'); 
            btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
            
            const tplId = el('reg-template-select').value, tpl = cache.templates.find(t => t.id === tplId);
            let datosForm = {}, datosExcel = [];
            
            if(tpl.tipo === 'excel') { 
                document.querySelectorAll('#grid-body tr').forEach(tr => { let fila = {}; tr.querySelectorAll('.grid-input').forEach(input => fila[input.dataset.col] = input.value); if(Object.keys(fila).length > 0) datosExcel.push(fila); }); 
                if(datosExcel.length === 0){ btn.disabled = false; btn.innerHTML = 'PROCESAR Y ENVIAR'; return showToast("La grilla está vacía", "warning"); } 
            } else { 
                document.querySelectorAll('.dyn-field').forEach(el => datosForm[el.dataset.name] = el.value); 
            }

            let responsableAsignado = null, p = 'media', r = 'Revisión solicitada';
            let estadoInicial = 'Registrado';

            if (tpl.flujoConfig.tipo !== 'solo_registro') {
                if (tpl.flujoConfig.asignacion === 'dinamico') {
                    responsableAsignado = el('dyn-flow-user').value;
                    p = el('dyn-flow-priority').value;
                    r = el('dyn-flow-reason').value || r;
                } else {
                    responsableAsignado = tpl.flujoConfig.usuarioFijo;
                }
                if(tpl.flujoConfig.tipo === 'aprobacion') estadoInicial = 'Pendiente de Aprobación';
            }

            const ref = await addDoc(collection(db, "am_registros"), { usuarioId: currentUser.id, plantillaId: tplId, plantillaNombre: tpl.nombre, grupoId: tpl.grupoId, tipoRegistro: tpl.tipo, datos: datosForm, datosExcel: datosExcel, adjunto: el('reg-file').value.split('\\').pop() || null, estado: estadoInicial, asignadoEnFlujo: responsableAsignado, fecha: new Date().toLocaleString(), timestamp: Date.now() });

            if(tpl.flujoConfig.tipo === 'tarea') {
                await addDoc(collection(db, "am_tareas"), { registroPadreId: ref.id, asignadoA: responsableAsignado, motivo: r, prioridad: p, estadoTarea: 'Pendiente', fechaAsig: new Date().toLocaleDateString(), timestamp: Date.now() });
                showToast(`Datos guardados y Tarea enviada a ${responsableAsignado}`);
            } else if (tpl.flujoConfig.tipo === 'aprobacion') {
                showToast(`Enviado para aprobación a ${responsableAsignado}`);
            } else { showToast("Registro guardado con éxito."); }

            e.target.reset(); el('dynamic-form').classList.add('d-none'); el('reg-template-select').value = ""; btn.disabled = false; btn.innerHTML = '<i class="bi bi-send-check-fill me-2"></i> PROCESAR Y ENVIAR';
        }

        // --- FUNCIONES GLOBALES (VENTANA) PARA BOTONES GENERADOS DINÁMICAMENTE ---
        window.delGroup = async (id) => { if(confirm("¿Eliminar departamento?")) await deleteDoc(doc(db, "am_grupos", id)); };
        window.delUser = async (id) => { if(confirm("¿Remover usuario?")) await deleteDoc(doc(db, "am_usuarios", id)); };
        window.delTpl = async (id) => { if(confirm("¿Borrar plantilla?")) await deleteDoc(doc(db, "am_plantillas", id)); };
        window.completarTarea = async (id) => { if(confirm("¿Marcar completada?")) await updateDoc(doc(db, "am_tareas", id), { estadoTarea: 'Completada' }); };
        window.cambiarEstadoReg = async (id, st) => await updateDoc(doc(db, "am_registros", id), { estado: st }); 
        window.delReg = async (id) => { if(confirm("¿Eliminar registro?")) await deleteDoc(doc(db, "am_registros", id)); };
        window.exportarTabla = (tId, n) => { const t = el(tId); if(!t) return; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([`<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"></head><body><table border="1">${t.innerHTML}</table></body></html>`], {type: 'application/vnd.ms-excel'})); a.download = `${n}.xls`; a.click(); };

        // --- SINCRONIZACIÓN FIREBASE (TIEMPO REAL) ---
        function startRealtimeListeners() {
            onSnapshot(collection(db, "am_grupos"), s => {
                cache.groups = s.docs.map(d => ({id: d.id, ...d.data()}));
                el('list-groups').innerHTML = cache.groups.map(g => `<li class="list-group-item d-flex justify-content-between align-items-center"><span class="fw-bold text-dark"><i class="bi bi-folder-fill text-warning me-2"></i>${g.nombre}</span><i class="bi bi-trash text-danger pointer hover-scale" onclick="window.delGroup('${g.id}')"></i></li>`).join('');
                el('tpl-group').innerHTML = '<option value="">- Seleccionar -</option>' + cache.groups.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
                el('usr-groups-container').innerHTML = cache.groups.map(g => `<div class="col-6 col-md-4"><div class="border rounded-3 p-2 bg-white hover-scale pointer"><input class="form-check-input ms-1 me-2 grp-chk pointer" type="checkbox" value="${g.id}" id="chk-grp-${g.id}"><label class="form-check-label small pointer text-secondary fw-bold" for="chk-grp-${g.id}">${g.nombre}</label></div></div>`).join('');
            });

            onSnapshot(collection(db, "am_usuarios"), s => {
                cache.users = s.docs.map(d => ({id: d.id, ...d.data()}));
                el('list-users').innerHTML = cache.users.map(u => `<li class="list-group-item d-flex justify-content-between align-items-center"><div><div class="fw-bold text-dark"><i class="bi bi-person-circle text-primary me-2"></i>${u.id} <span class="badge bg-light text-primary border ms-1">${u.rol}</span></div><small class="text-muted"><i class="bi bi-diagram-2 ms-4 me-1"></i>${u.grupos?.join(', ') || 'Sin grupos'}</small></div><i class="bi bi-trash text-danger pointer hover-scale" onclick="window.delUser('${u.id}')"></i></li>`).join('');
                el('flow-fixed-user').innerHTML = '<option value="">- Seleccione Usuario -</option>' + cache.users.map(u => `<option value="${u.id}">${u.id} (${u.rol})</option>`).join('');
            });

            onSnapshot(collection(db, "am_plantillas"), s => {
                cache.templates = s.docs.map(d => ({id: d.id, ...d.data()}));
                const ms = currentUser.rol === 'admin' ? cache.templates : cache.templates.filter(t => (currentUser.grupos || []).includes(t.grupoId));
                el('reg-template-select').innerHTML = '<option value="">- ELEGIR FORMATO -</option>' + ms.map(t => `<option value="${t.id}">[${t.tipo.toUpperCase()}] ${t.nombre}</option>`).join('');
                el('list-templates').innerHTML = cache.templates.map(t => `<li class="list-group-item d-flex justify-content-between align-items-center"><div class="lh-sm"><span class="fw-bold text-dark d-block mb-1">${t.nombre}</span><span class="badge bg-primary bg-opacity-10 text-primary me-1">${t.tipo}</span><span class="badge bg-dark bg-opacity-10 text-dark me-1">${t.grupoId}</span><small class="text-secondary fw-bold d-block mt-1"><i class="bi bi-arrow-return-right me-1"></i>Flujo: ${t.flujoConfig.tipo}</small></div><i class="bi bi-trash text-danger pointer p-2 shadow-sm rounded-circle bg-light border hover-scale" onclick="window.delTpl('${t.id}')"></i></li>`).join('');
            });

             onSnapshot(collection(db, "am_tareas"), s => {
                const misTareas = s.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.asignadoA === currentUser.id && t.estadoTarea === 'Pendiente');
                el('dash-tasks').innerText = misTareas.length;
                el('body-mistareas').innerHTML = misTareas.map(t => `<tr><td class="ps-4"><span class="status-badge bg-${t.prioridad === 'alta' ? 'danger text-white' : (t.prioridad === 'media' ? 'warning text-dark' : 'success text-white')}">${t.prioridad}</span></td><td class="fw-bold text-dark">${t.motivo}<br><small class="text-primary fw-normal">Ref Doc: ${t.registroPadreId.substring(0,6)}</small></td><td><span class="badge bg-light text-dark border">${t.fechaAsig}</span></td><td><span class="status-badge bg-st-pendiente border">PENDIENTE</span></td><td><button class="btn btn-sm btn-success fw-bold shadow-sm" onclick="window.completarTarea('${t.id}')"><i class="bi bi-check-lg me-1"></i> Listo</button></td></tr>`).join('') || '<tr><td colspan="5" class="text-center py-4 text-muted"><i class="bi bi-emoji-smile fs-3 d-block mb-2 text-secondary"></i>Bandeja limpia.</td></tr>';
             });

            onSnapshot(query(collection(db, "am_registros"), orderBy('timestamp', 'desc')), s => {
                el('dash-total').innerText = s.size;
                el('body-global').innerHTML = s.docs.map(d => {
                    const r = d.data(); r.id = d.id;
                    let resumenStr = r.tipoRegistro === 'excel' ? `<span class="badge bg-dark">${r.datosExcel.length} Filas Cargadas</span>` : Object.keys(r.datos).slice(0,2).map(k => `<span class="text-muted">${k}:</span> <b class="text-dark">${r.datos[k]}</b>`).join('<br>');
                    let stClass = r.estado.includes('Pendiente') ? 'bg-st-pendiente' : (r.estado === 'Aprobado' ? 'bg-st-aprobado' : (r.estado === 'Rechazado' ? 'bg-st-rechazado' : 'bg-st-registrado'));
                    let flujoAsignado = r.asignadoEnFlujo ? `<small class="d-block text-primary fw-bold mt-1"><i class="bi bi-person-gear"></i> ${r.asignadoEnFlujo}</small>` : '';

                    let acciones = '<span class="text-muted small">-</span>';
                    if(r.estado.includes('Pendiente') && (currentUser.rol === 'admin' || currentUser.id === r.asignadoEnFlujo)){
                         acciones = `<div class="btn-group shadow-sm"><button class="btn btn-sm btn-success fw-bold" onclick="window.cambiarEstadoReg('${r.id}','Aprobado')"><i class="bi bi-check-lg"></i></button><button class="btn btn-sm btn-danger fw-bold" onclick="window.cambiarEstadoReg('${r.id}','Rechazado')"><i class="bi bi-x-lg"></i></button></div>`;
                    }
                    if(currentUser.rol === 'admin') acciones += `<button class="btn btn-sm btn-outline-danger ms-2 border-0" onclick="window.delReg('${r.id}')"><i class="bi bi-trash fs-5"></i></button>`;

                    return `<tr><td class="ps-4"><span class="badge bg-light text-secondary border">${r.fecha.split(' ')[0]}</span></td><td><span class="badge bg-primary bg-opacity-10 text-primary border">${r.tipoRegistro.toUpperCase()}</span></td><td class="fw-bold text-dark"><small>${r.plantillaNombre}</small></td><td><span class="badge bg-light text-dark border">${r.grupoId}</span></td><td class="small" style="max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${resumenStr}</td><td><span class="status-badge ${stClass}">${r.estado}</span>${flujoAsignado}</td><td>${acciones}</td></tr>`;
                }).join('');
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
