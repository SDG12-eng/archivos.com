<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArchiveMaster Enterprise - Control Total</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        :root { --primary: #2563eb; --primary-dark: #1d4ed8; --sidebar-width: 280px; --bg-body: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); overflow-x: hidden; color: #334155; }
        .pointer { cursor: pointer; } 
        ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .scroll-y { max-height: 60vh; overflow-y: auto; }
        
        /* Layout */
        #sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top:0; left:0; background: #0f172a; color: #f8fafc; z-index: 1000; transition: 0.3s; }
        #main-content { margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column; }
        .nav-link-custom { padding: 12px 20px; margin: 4px 16px; border-radius: 10px; color: #94a3b8; font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 12px; transition: all 0.2s; }
        .nav-link-custom:hover, .nav-link-custom.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-link-custom.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        /* Componentes UX */
        .card-custom { border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); background: white; }
        .card-header-custom { background: transparent; border-bottom: 1px solid #f1f5f9; padding: 20px 24px; font-weight: 800; color: #1e293b; font-size: 1.1rem; }
        .btn-primary-c { background: var(--primary); border: none; padding: 12px 24px; border-radius: 12px; font-weight: 700; color: white; transition: 0.2s; }
        .btn-primary-c:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        .form-control, .form-select { border-radius: 10px; padding: 0.75rem 1rem; border: 1px solid #cbd5e1; background-color: #f8fafc; font-size: 0.95rem; }
        .form-control:focus, .form-select:focus { box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); border-color: var(--primary); background-color: white; }
        
        /* Badges & Checkboxes */
        .status-pill { padding: 6px 14px; border-radius: 20px; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .st-pendiente { background: #fff7ed; color: #c2410c; }
        .st-aprobado { background: #f0fdf4; color: #15803d; }
        .st-rechazado { background: #fef2f2; color: #b91c1c; }
        .st-registrado { background: #f1f5f9; color: #475569; }
        
        /* Estilos Especiales para UI Multiselect y Grillas */
        .group-checkbox-card { transition: 0.2s; border: 2px solid transparent; cursor: pointer; }
        .group-checkbox-card:hover { border-color: #cbd5e1; background: #f8fafc; }
        .group-checkbox-card input:checked + label { color: var(--primary); font-weight: bold; }
        .grid-table th { background: #f1f5f9; font-size: 0.8rem; text-transform: uppercase; color: #475569; letter-spacing: 0.5px; border-bottom: 2px solid #e2e8f0; }
        .grid-table input { border: none; background: transparent; width: 100%; padding: 10px; outline: none; }
        .grid-table input:focus { background: #e0e7ff; }
        
        /* Paneles de Flujo */
        .flow-panel { background: #eff6ff; border: 1px dashed #93c5fd; border-radius: 16px; padding: 20px; transition: 0.3s; }
    </style>
</head>
<body>
    <div class="toast-container position-fixed top-0 end-0 p-4" style="z-index: 2000;" id="toast-container"></div>

    <div id="login-screen" class="vh-100 d-flex justify-content-center align-items-center" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
        <div class="card card-custom p-5 border-0 shadow-lg" style="width: 420px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);">
            <div class="text-center mb-4">
                <i class="bi bi-hexagon-fill fs-1 text-primary"></i>
                <h3 class="fw-bold mt-2 text-dark">ArchiveMaster</h3>
                <p class="text-muted small fw-semibold">ENTERPRISE EDITION</p>
            </div>
            <form id="login-form">
                <div class="form-floating mb-3"><input type="text" class="form-control" id="login-user" placeholder="Usuario" required><label>ID de Usuario</label></div>
                <div class="form-floating mb-4"><input type="password" class="form-control" id="login-pass" placeholder="Contraseña" required><label>Contraseña Segura</label></div>
                <button type="submit" class="btn btn-primary-c w-100 py-3">Ingresar al Sistema</button>
            </form>
        </div>
    </div>

    <div id="app-screen" class="d-none">
        <aside id="sidebar" class="shadow-lg">
            <div class="p-4 d-flex align-items-center gap-3 mb-2 border-bottom border-secondary border-opacity-25">
                <i class="bi bi-hexagon-half text-primary fs-3"></i>
                <div><h5 class="mb-0 fw-bold">ArchiveMaster</h5><small class="text-primary fw-bold" style="font-size: 0.7rem; letter-spacing: 1px;">ENTERPRISE</small></div>
            </div>
            <div class="px-4 py-3 mb-2">
                <div class="d-flex align-items-center gap-3 p-3 rounded-4" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                    <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center fw-bold fs-5" style="width: 48px; height: 48px;" id="avatar-initial">U</div>
                    <div style="line-height: 1.2;"><h6 class="mb-1 fw-bold text-white" id="user-display">Usuario</h6><span class="badge bg-primary bg-opacity-25 text-info" id="role-display" style="font-size: 0.65rem;">ROL</span></div>
                </div>
            </div>
            <nav id="menu-dinamico" class="mt-2 pb-5 scroll-y"></nav>
            <div class="position-absolute bottom-0 w-100 p-4 border-top border-secondary border-opacity-25" style="background: #0f172a;">
                <button class="btn btn-danger bg-opacity-10 text-danger border-0 w-100 text-start fw-bold p-3 rounded-3 hover-scale" id="btn-logout"><i class="bi bi-box-arrow-left me-2"></i> Cerrar Sesión</button>
            </div>
        </aside>

        <main id="main-content">
            <header class="bg-white py-3 px-4 d-flex justify-content-between align-items-center sticky-top border-bottom" style="z-index: 900;">
                <h4 class="mb-0 fw-bold text-slate-800" id="section-title">Dashboard</h4>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-muted small fw-bold bg-light px-3 py-2 rounded-pill border" id="datetime-display"></span>
                </div>
            </header>

            <div class="container-fluid p-4">
                
                <div id="sec-dashboard" class="content-section d-none">
                    <div class="row g-4 mb-4">
                        <div class="col-md-4"><div class="card-custom p-4 d-flex align-items-center gap-4"><div class="bg-primary bg-opacity-10 p-4 rounded-circle text-primary"><i class="bi bi-hdd-stack fs-2"></i></div><div><small class="text-muted fw-bold text-uppercase">Volumen de Datos</small><h2 class="fw-black mb-0" id="dash-total">0</h2></div></div></div>
                        <div class="col-md-4"><div class="card-custom p-4 d-flex align-items-center gap-4"><div class="bg-warning bg-opacity-10 p-4 rounded-circle text-warning"><i class="bi bi-list-check fs-2"></i></div><div><small class="text-muted fw-bold text-uppercase">Mis Tareas / Revisiones</small><h2 class="fw-black mb-0" id="dash-tasks">0</h2></div></div></div>
                    </div>
                </div>

                <div id="sec-registrar" class="content-section d-none">
                    <div class="card-custom mx-auto shadow-sm" style="max-width: 900px;">
                        <div class="card-header-custom d-flex justify-content-between align-items-center bg-light rounded-top-4">
                            <span class="fs-5"><i class="bi bi-journal-plus me-2 text-primary"></i> Ingreso de Nueva Información</span>
                        </div>
                        <div class="card-body p-4 p-md-5">
                            <label class="form-label small fw-bold text-muted text-uppercase mb-2">Seleccione el Formato de Registro</label>
                            <select id="reg-template-select" class="form-select form-select-lg mb-5 fw-bold text-primary shadow-sm"></select>
                            
                            <form id="dynamic-form" class="d-none">
                                <input type="hidden" id="current-tpl-type">
                                
                                <div id="standard-fields-container" class="row g-4 mb-4"></div>
                                <div id="grid-container" class="d-none mb-4">
                                    <div class="table-responsive border rounded-3 overflow-hidden shadow-sm">
                                        <table class="table grid-table mb-0 bg-white" id="grid-table">
                                            <thead id="grid-header"></thead><tbody id="grid-body"></tbody>
                                        </table>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-light border mt-3 fw-bold text-primary px-4 py-2" id="btn-add-row"><i class="bi bi-plus-lg me-1"></i> Añadir Fila a la Grilla</button>
                                </div>

                                <div class="bg-slate-50 p-4 rounded-4 border mb-4">
                                    <label class="small fw-bold text-dark mb-2"><i class="bi bi-paperclip text-primary"></i> Archivo Adjunto o Evidencia (Opcional)</label>
                                    <input type="file" id="reg-file" class="form-control bg-white">
                                </div>

                                <div id="dynamic-flow-section" class="d-none flow-panel mb-5 shadow-sm">
                                    <h6 class="fw-bold text-primary mb-3"><i class="bi bi-diagram-3-fill me-2"></i> Configuración de Flujo Requerida</h6>
                                    <p class="small text-muted mb-4" id="dynamic-flow-desc">Este formulario requiere que asignes a un responsable para continuar el proceso.</p>
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-5">
                                            <label class="form-label small fw-bold text-dark" id="dynamic-flow-label">Asignar A:</label>
                                            <select id="dyn-flow-user" class="form-select border-primary" required></select>
                                        </div>
                                        <div class="col-md-3 d-none" id="dyn-flow-priority-container">
                                            <label class="form-label small fw-bold text-dark">Prioridad:</label>
                                            <select id="dyn-flow-priority" class="form-select border-primary"><option value="baja">Baja</option><option value="media" selected>Media</option><option value="alta">Alta</option></select>
                                        </div>
                                        <div class="col-md-12 d-none" id="dyn-flow-reason-container">
                                            <label class="form-label small fw-bold text-dark">Instrucciones / Motivo:</label>
                                            <input type="text" id="dyn-flow-reason" class="form-control border-primary" placeholder="Detalle qué debe hacer el responsable...">
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">
                                <div class="text-end"><button type="submit" class="btn btn-primary-c px-5 shadow"><i class="bi bi-send-check-fill me-2"></i> PROCESAR Y ENVIAR DATOS</button></div>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="sec-mistareas" class="content-section d-none">
                    <div class="card-custom">
                        <div class="card-header-custom bg-light"><i class="bi bi-inbox-fill text-primary me-2"></i> Bandeja de Tareas y Aprobaciones</div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-white text-uppercase small text-muted border-bottom"><tr><th class="ps-4">Prioridad</th><th>Tarea / Motivo</th><th>Asignado El</th><th>Estado</th><th>Acción</th></tr></thead>
                                    <tbody id="body-mistareas"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sec-historial" class="content-section d-none">
                    <div class="card-custom">
                        <div class="card-header-custom d-flex justify-content-between align-items-center bg-light">
                            <span><i class="bi bi-database-fill-gear text-primary me-2"></i> Master Data Central</span>
                            <button class="btn btn-sm btn-dark fw-bold px-3 rounded-pill" onclick="exportarTabla('table-global', 'MasterData_Export')"><i class="bi bi-cloud-arrow-down-fill me-1"></i> Bajar a Excel</button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 65vh; overflow-y: auto;">
                                <table class="table table-hover align-middle mb-0" id="table-global">
                                    <thead class="bg-white text-muted small text-uppercase sticky-top shadow-sm"><tr><th class="ps-4">Fecha</th><th>Tipo</th><th>Formulario Base</th><th>Grupo Origen</th><th>Responsable/Flujo</th><th>Estado Actual</th><th>Gestión</th></tr></thead>
                                    <tbody id="body-global"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sec-admin" class="content-section d-none">
                    <div class="bg-white p-2 rounded-4 shadow-sm mb-4 d-inline-flex border">
                        <button class="btn btn-light rounded-3 fw-bold px-4 me-2 active" data-bs-toggle="pill" data-bs-target="#tab-tpls">1. Constructor de Formularios & Flujos</button>
                        <button class="btn btn-light rounded-3 fw-bold px-4 me-2" data-bs-toggle="pill" data-bs-target="#tab-users">2. Gestión de Usuarios y Accesos</button>
                        <button class="btn btn-light rounded-3 fw-bold px-4" data-bs-toggle="pill" data-bs-target="#tab-groups">3. Departamentos / Grupos</button>
                    </div>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-tpls">
                            <div class="row g-4">
                                <div class="col-lg-7">
                                    <div class="card-custom h-100">
                                        <div class="card-body p-4 p-lg-5">
                                            <h5 class="fw-bold text-dark mb-4"><i class="bi bi-layout-text-window-reverse text-primary me-2"></i> Diseño de Nuevo Registro</h5>
                                            <div class="row g-3 mb-4">
                                                <div class="col-md-12"><input type="text" id="tpl-name" class="form-control form-control-lg fw-bold" placeholder="Ej. Inspección de Calidad"></div>
                                                <div class="col-md-6"><label class="small fw-bold text-muted mb-1">Estructura Base</label><select id="tpl-type" class="form-select fw-bold"><option value="formulario">Formulario Clásico</option><option value="excel">Grilla Dinámica (Tipo Excel)</option><option value="inventario">Gestión de Inventario</option></select></div>
                                                <div class="col-md-6"><label class="small fw-bold text-muted mb-1">Grupo Propietario</label><select id="tpl-group" class="form-select fw-bold"><option value="">- Seleccionar Grupo -</option></select></div>
                                            </div>
                                            
                                            <div class="bg-slate-50 border rounded-4 p-4 mb-4">
                                                <h6 class="fw-bold small text-muted text-uppercase mb-3"><i class="bi bi-columns-gap me-1"></i> Columnas / Preguntas del Formulario</h6>
                                                <div class="d-flex gap-2 mb-3">
                                                    <input type="text" id="field-name" class="form-control" placeholder="Nombre del Campo">
                                                    <select id="field-type" class="form-select" style="max-width: 160px;"><option value="text">Texto Corto</option><option value="number">Número</option><option value="date">Fecha</option><option value="select">Lista de Opciones</option><option value="textarea">Texto Largo</option></select>
                                                    <button class="btn btn-dark px-4 rounded-3" id="btn-add-field"><i class="bi bi-plus-lg"></i></button>
                                                </div>
                                                <input type="text" id="field-options" class="form-control mb-3 d-none" placeholder="Opciones separadas por coma (A, B, C)">
                                                <div id="builder-fields-container" class="d-flex flex-wrap gap-2 mt-2"></div>
                                            </div>

                                            <div class="flow-panel mb-4">
                                                <h6 class="fw-bold text-primary mb-3"><i class="bi bi-diagram-3-fill me-2"></i> Reglas de Flujo y Aprobación</h6>
                                                <select id="flow-type" class="form-select mb-3 fw-bold border-primary">
                                                    <option value="solo_registro">Finalizar Automáticamente (Solo Registrar Datos)</option>
                                                    <option value="aprobacion">El Registro requiere Aprobación</option>
                                                    <option value="tarea">Generar una Tarea a un responsable tras registrar</option>
                                                </select>
                                                
                                                <div id="flow-config-details" class="d-none bg-white p-3 rounded-3 border">
                                                    <label class="small fw-bold text-dark mb-2">¿Cómo se elige al responsable/aprobador?</label>
                                                    <select id="flow-assignment-type" class="form-select mb-3">
                                                        <option value="dinamico">Selección Dinámica (El usuario lo elige al llenar el formulario)</option>
                                                        <option value="fijo">Selección Permanente (Siempre se enviará a la misma persona)</option>
                                                    </select>
                                                    
                                                    <div id="flow-fixed-user-container" class="d-none">
                                                        <label class="small fw-bold text-dark mb-2">Seleccione al responsable permanente:</label>
                                                        <select id="flow-fixed-user" class="form-select"><option value="">- Directorio Vacio -</option></select>
                                                    </div>
                                                </div>
                                            </div>

                                            <button class="btn btn-primary-c w-100 py-3 shadow" id="btn-save-tpl">PUBLICAR FORMULARIO EN EL SISTEMA</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="card-custom h-100 scroll-y"><div class="card-header-custom bg-light">Catálogo de Formularios</div><div class="card-body p-0"><ul id="list-templates" class="list-group list-group-flush"></ul></div></div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-users">
                            <div class="row g-4">
                                <div class="col-lg-5">
                                    <div class="card-custom h-100">
                                        <div class="card-header-custom bg-light"><i class="bi bi-person-badge-fill text-primary me-2"></i> Ficha de Usuario</div>
                                        <div class="card-body p-4">
                                            <form id="form-user">
                                                <div class="row g-3 mb-4">
                                                    <div class="col-12"><input type="text" id="usr-id" class="form-control fw-bold" placeholder="ID de Acceso (Ej. mperez)" required></div>
                                                    <div class="col-12"><input type="password" id="usr-pass" class="form-control" placeholder="Contraseña Inicial" required></div>
                                                    <div class="col-12"><select id="usr-rol" class="form-select fw-bold"><option value="usuario">Nivel: Usuario Operativo</option><option value="revisor">Nivel: Supervisor / Revisor</option><option value="admin">Nivel: Administrador del Sistema</option></select></div>
                                                </div>
                                                
                                                <div class="mb-4">
                                                    <label class="fw-bold small text-dark mb-3 text-uppercase border-bottom pb-2 d-block">Asignación a Departamentos / Grupos</label>
                                                    <div id="usr-groups-container" class="row g-2 px-1">
                                                        <div class="text-muted small">Cree grupos primero en la pestaña 3.</div>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-4 bg-slate-50 p-3 rounded-4 border">
                                                    <label class="fw-bold small text-dark mb-2 d-block">Visibilidad de Menú</label>
                                                    <div class="d-flex flex-wrap gap-3">
                                                        <div class="form-check"><input class="form-check-input perm-chk" type="checkbox" value="dashboard" id="p-dash" checked><label class="form-check-label small" for="p-dash">Dash</label></div>
                                                        <div class="form-check"><input class="form-check-input perm-chk" type="checkbox" value="registrar" id="p-reg" checked><label class="form-check-label small" for="p-reg">Registros</label></div>
                                                        <div class="form-check"><input class="form-check-input perm-chk" type="checkbox" value="mistareas" id="p-task" checked><label class="form-check-label small" for="p-task">Inbox/Tareas</label></div>
                                                        <div class="form-check"><input class="form-check-input perm-chk" type="checkbox" value="historial" id="p-hist"><label class="form-check-label small" for="p-hist">MasterData</label></div>
                                                        <div class="form-check"><input class="form-check-input perm-chk" type="checkbox" value="admin" id="p-adm"><label class="form-check-label small" for="p-adm">Ajustes</label></div>
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-dark w-100 py-3 rounded-3 fw-bold">GUARDAR FICHA DE USUARIO</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-7">
                                     <div class="card-custom h-100 scroll-y"><div class="card-header-custom bg-light">Directorio Activo</div><div class="card-body p-0"><ul id="list-users" class="list-group list-group-flush"></ul></div></div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-groups">
                            <div class="row g-4">
                                <div class="col-md-5">
                                    <div class="card-custom h-100">
                                        <div class="card-header-custom bg-dark text-white"><i class="bi bi-diagram-2-fill me-2"></i> Crear Nuevo Grupo</div>
                                        <div class="card-body p-4">
                                            <form id="form-group">
                                                <div class="mb-3"><input type="text" id="grp-id" class="form-control fw-bold" placeholder="ID Corto (Ej. logistica_nacional)" required></div>
                                                <div class="mb-4"><input type="text" id="grp-name" class="form-control" placeholder="Nombre a Mostrar (Ej. Logística Nacional)" required></div>
                                                <button type="submit" class="btn btn-primary-c w-100">Crear Departamento</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <div class="card-custom h-100 scroll-y"><div class="card-header-custom bg-light">Departamentos del Sistema</div><div class="card-body p-0"><ul id="list-groups" class="list-group list-group-flush"></ul></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, updateDoc, addDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        
        // CONFIGURACIÓN (Asegúrate de poner la tuya)
        const firebaseConfig = { apiKey: "AIzaSyA3cRmakg2dV2YRuNV1fY7LE87artsLmB8", authDomain: "mi-web-db.firebaseapp.com", projectId: "mi-web-db", storageBucket: "mi-web-db.appspot.com" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        // ESTADO
        let currentUser = null; let tempFields = []; let gridColumns = []; let cache = { templates: [], groups: [], users: [] };
        const showToast=(m,t='success')=>{const b=document.getElementById('toast-container');b.innerHTML+=`<div class="toast show align-items-center text-bg-${t} border-0 p-3 mb-2 shadow-lg rounded-3"><div class="d-flex"><div class="toast-body fw-bold"><i class="bi bi-${t=='success'?'check-circle':'exclamation-triangle'}-fill me-2 fs-5"></i>${m}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;setTimeout(()=>{b.firstChild?.remove()},4000)};

        // INIT & NAVEGACIÓN
        window.addEventListener('DOMContentLoaded', () => { setInterval(()=>document.getElementById('datetime-display').innerText=new Date().toLocaleString('es-ES',{dateStyle:'short',timeStyle:'short'}),1000); const s = localStorage.getItem("am_enterprise_session"); if(s) initApp(JSON.parse(s)); });
        document.getElementById('login-form').addEventListener('submit', async e => { e.preventDefault(); const u=document.getElementById("login-user").value.trim().toLowerCase(), p=document.getElementById("login-pass").value.trim(); if(u==="admin"&&p==="1130"){ initApp({id:"admin",rol:"admin",accesos:["dashboard","registrar","mistareas","historial","admin"], grupos:[]}); return; } try { const s=await getDoc(doc(db,"am_usuarios",u)); if(s.exists()&&s.data().pass===p) initApp({id:u,...s.data()}); else showToast("Datos incorrectos","danger"); } catch(e){showToast("Error de red","danger");} });
        document.getElementById('btn-logout').addEventListener('click',()=>{localStorage.removeItem("am_enterprise_session");location.reload()});
        function initApp(u){ currentUser=u; localStorage.setItem("am_enterprise_session",JSON.stringify(u)); document.getElementById("login-screen").classList.add("d-none"); document.getElementById("app-screen").classList.remove("d-none"); document.getElementById("user-display").innerText=u.id; document.getElementById("role-display").innerText=u.rol.toUpperCase(); document.getElementById("avatar-initial").innerText=u.id[0].toUpperCase(); const navMap={dashboard:{id:'sec-dashboard',n:'Panel Principal',i:'pie-chart-fill'},registrar:{id:'sec-registrar',n:'Realizar Registro',i:'journal-plus'},mistareas:{id:'sec-mistareas',n:'Bandeja de Tareas',i:'inbox-fill'},historial:{id:'sec-historial',n:'Master Data Central',i:'database-fill'},admin:{id:'sec-admin',n:'Ajustes del Sistema',i:'sliders'}}; document.getElementById("menu-dinamico").innerHTML = u.accesos.map(a=>navMap[a]?`<div class="nav-link-custom pointer" id="nav-${a}" onclick="navigateTo('${a}')"><i class="bi bi-${navMap[a].i} fs-5"></i><span>${navMap[a].n}</span></div>`:'').join(''); window.navigateTo = (sId)=>{ document.querySelectorAll(".content-section").forEach(e=>e.classList.add("d-none")); document.querySelectorAll(".nav-link-custom").forEach(e=>e.classList.remove("active")); document.getElementById(navMap[sId].id).classList.remove("d-none"); document.getElementById(`nav-${sId}`)?.classList.add("active"); document.getElementById("section-title").innerText=navMap[sId].n; }; if(u.accesos.length>0) navigateTo(u.accesos[0]); startRealtimeListeners(); }

        // ================= ADMIN: CONSTRUCTOR DE PLANTILLAS Y FLUJOS =================
        document.getElementById('field-type').addEventListener('change',e=>document.getElementById('field-options').classList.toggle('d-none',e.target.value!=='select'));
        document.getElementById('btn-add-field').addEventListener('click',()=>{ const n=document.getElementById('field-name').value.trim(), t=document.getElementById('field-type').value, o=document.getElementById('field-options').value.trim(); if(!n)return; tempFields.push({name:n,type:t,options:t==='select'?o.split(',').map(x=>x.trim()):[]}); document.getElementById('builder-fields-container').innerHTML=tempFields.map((f,i)=>`<span class="badge bg-white border border-secondary text-dark p-2 rounded-pill shadow-sm"><i class="bi bi-list-task me-1 text-primary"></i>${f.name} <i class="bi bi-x-circle-fill text-danger pointer ms-2 hover-scale" onclick="tempFields.splice(${i},1);this.parentElement.remove()"></i></span>`).join(''); document.getElementById('field-name').value='';document.getElementById('field-options').value=''; });
        
        // Lógica de UI para Configuración de Flujo
        document.getElementById('flow-type').addEventListener('change', e => {
            const flow = e.target.value;
            const detailBox = document.getElementById('flow-config-details');
            if(flow === 'solo_registro') { detailBox.classList.add('d-none'); } 
            else { detailBox.classList.remove('d-none'); }
        });

        document.getElementById('flow-assignment-type').addEventListener('change', e => {
            document.getElementById('flow-fixed-user-container').classList.toggle('d-none', e.target.value === 'dinamico');
        });

        document.getElementById('btn-save-tpl').addEventListener('click', async ()=>{
            const nom=document.getElementById('tpl-name').value.trim(), tipo=document.getElementById('tpl-type').value, grp=document.getElementById('tpl-group').value;
            const flowT=document.getElementById('flow-type').value, assignT=document.getElementById('flow-assignment-type').value, fixedU=document.getElementById('flow-fixed-user').value;
            
            if(!nom || !grp || tempFields.length===0) return showToast("Completar Nombre, Grupo y añadir campos","danger");
            if(flowT !== 'solo_registro' && assignT === 'fijo' && !fixedU) return showToast("Seleccione al usuario fijo para el flujo", "warning");

            const flujoConfig = { tipo: flowT, asignacion: assignT, usuarioFijo: fixedU };

            await addDoc(collection(db,"am_plantillas"), { nombre:nom, tipo, grupoId:grp, campos:tempFields, flujoConfig, timestamp:Date.now() });
            showToast("Estructura publicada exitosamente."); document.getElementById('tpl-name').value=''; tempFields=[]; document.getElementById('builder-fields-container').innerHTML='';
        });
        window.delTpl=async id=>{if(confirm("¿Retirar formulario?"))await deleteDoc(doc(db,"am_plantillas",id))};

        // ================= ADMIN: GRUPOS Y USUARIOS =================
        document.getElementById('form-group').addEventListener('submit', async e => { e.preventDefault(); await setDoc(doc(db,"am_grupos",document.getElementById('grp-id').value.trim()),{nombre:document.getElementById('grp-name').value.trim()}); showToast("Departamento creado"); e.target.reset(); });
        window.delGroup=async id=>{if(confirm("¿Borrar grupo?"))await deleteDoc(doc(db,"am_grupos",id))};
        
        document.getElementById('form-user').addEventListener('submit', async e => { e.preventDefault();
            const id=document.getElementById('usr-id').value.trim().toLowerCase(), pass=document.getElementById('usr-pass').value.trim();
            let accesos=[], grupos=[];
            document.querySelectorAll('.perm-chk:checked').forEach(c=>accesos.push(c.value));
            document.querySelectorAll('.grp-chk:checked').forEach(c=>grupos.push(c.value));
            await setDoc(doc(db,"am_usuarios",id),{pass,rol:document.getElementById('usr-rol').value,accesos,grupos},{merge:true}); showToast("Ficha de usuario guardada"); e.target.reset();
        });
        window.delUser=async id=>{if(confirm("¿Dar de baja al usuario?"))await deleteDoc(doc(db,"am_usuarios",id))};

        // ================= USUARIOS: REGISTRO Y FLUJO DINÁMICO =================
        document.getElementById('reg-template-select').addEventListener('change', e => {
            const tplId = e.target.value; const form=document.getElementById('dynamic-form');
            if(!tplId){form.classList.add('d-none');return;} form.classList.remove('d-none');
            const tpl = cache.templates.find(t=>t.id===tplId); document.getElementById('current-tpl-type').value = tpl.tipo; gridColumns = tpl.campos;
            
            // 1. Renderizar Campos
            const stdContainer = document.getElementById('standard-fields-container'), gridContainer = document.getElementById('grid-container');
            if(tpl.tipo === 'formulario' || tpl.tipo === 'inventario') {
                gridContainer.classList.add('d-none'); stdContainer.innerHTML = tpl.campos.map(c => `<div class="${c.type==='textarea'?'col-12':'col-md-6'}"><label class="form-label small fw-bold text-dark">${c.name}</label>${c.type==='textarea'?`<textarea class="form-control dyn-field" data-name="${c.name}" required></textarea>`:(c.type==='select'?`<select class="form-select dyn-field" data-name="${c.name}" required><option value="">-Elegir-</option>${c.options.map(o=>`<option>${o}</option>`).join('')}</select>`:`<input type="${c.type}" class="form-control dyn-field" data-name="${c.name}" required>`)}</div>`).join('');
            } else { stdContainer.innerHTML = ''; gridContainer.classList.remove('d-none'); document.getElementById('grid-header').innerHTML = `<tr>${tpl.campos.map(c=>`<th class="fw-bold">${c.name}</th>`).join('')}<th></th></tr>`; document.getElementById('grid-body').innerHTML = ''; window.addGridRow(); }

            // 2. Renderizar UI de Flujo Dinámico
            const flowSec = document.getElementById('dynamic-flow-section');
            if (tpl.flujoConfig.tipo !== 'solo_registro' && tpl.flujoConfig.asignacion === 'dinamico') {
                flowSec.classList.remove('d-none');
                
                // Cargar usuarios en el select
                document.getElementById('dyn-flow-user').innerHTML = '<option value="">- Elegir Responsable -</option>' + cache.users.map(u=>`<option value="${u.id}">${u.id} (${u.rol})</option>`).join('');
                
                if (tpl.flujoConfig.tipo === 'tarea') {
                    document.getElementById('dynamic-flow-desc').innerText = "Configure a quién se le asignará la tarea producto de este registro.";
                    document.getElementById('dynamic-flow-label').innerText = "Asignar Tarea A:";
                    document.getElementById('dyn-flow-priority-container').classList.remove('d-none');
                    document.getElementById('dyn-flow-reason-container').classList.remove('d-none');
                    document.getElementById('dyn-flow-reason').required = true;
                } else if (tpl.flujoConfig.tipo === 'aprobacion') {
                    document.getElementById('dynamic-flow-desc').innerText = "Seleccione a la persona que deberá revisar y aprobar este registro.";
                    document.getElementById('dynamic-flow-label').innerText = "Enviar para Aprobación a:";
                    document.getElementById('dyn-flow-priority-container').classList.add('d-none');
                    document.getElementById('dyn-flow-reason-container').classList.add('d-none');
                    document.getElementById('dyn-flow-reason').required = false;
                }
            } else { flowSec.classList.add('d-none'); document.getElementById('dyn-flow-user').required = false; }
        });

        window.addGridRow = () => { document.getElementById('grid-body').insertAdjacentHTML('beforeend', `<tr>${gridColumns.map(c => `<td><input type="${c.type==='number'?'number':'text'}" class="grid-input fw-semibold text-primary" data-col="${c.name}" placeholder="Ingresar..."></td>`).join('')}<td class="text-center align-middle"><i class="bi bi-trash text-danger pointer fs-5 hover-scale" onclick="this.closest('tr').remove()"></i></td></tr>`); };

        document.getElementById('dynamic-form').addEventListener('submit', async e => { e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]'); btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
            const tplId = document.getElementById('reg-template-select').value, tpl = cache.templates.find(t => t.id === tplId);
            let datosForm = {}, datosExcel = [];
            
            // Recolección
            if(tpl.tipo === 'excel') { document.querySelectorAll('#grid-body tr').forEach(tr => { let fila = {}; tr.querySelectorAll('.grid-input').forEach(input => fila[input.dataset.col] = input.value); if(Object.keys(fila).length > 0) datosExcel.push(fila); }); if(datosExcel.length===0){btn.disabled=false; btn.innerHTML='PROCESAR Y ENVIAR DATOS'; return showToast("La grilla está vacía", "warning");} } 
            else { document.querySelectorAll('.dyn-field').forEach(el => datosForm[el.dataset.name] = el.value); }

            // Lógica de Responsables (Dinamico vs Fijo)
            let responsableAsignado = null, p=null, r=null;
            let estadoInicial = 'Registrado';

            if (tpl.flujoConfig.tipo !== 'solo_registro') {
                if (tpl.flujoConfig.asignacion === 'dinamico') {
                    responsableAsignado = document.getElementById('dyn-flow-user').value;
                    p = document.getElementById('dyn-flow-priority').value;
                    r = document.getElementById('dyn-flow-reason').value;
                    if(!responsableAsignado) { btn.disabled=false; return showToast("Debe elegir un responsable", "warning"); }
                } else {
                    responsableAsignado = tpl.flujoConfig.usuarioFijo;
                    p = 'media'; r = 'Revisión automática generada por sistema.';
                }
                
                if(tpl.flujoConfig.tipo === 'aprobacion') estadoInicial = 'Pendiente de Aprobación';
            }

            // Guardar Base
            const nuevoRegRef = await addDoc(collection(db, "am_registros"), { usuarioId: currentUser.id, plantillaId: tplId, plantillaNombre: tpl.nombre, grupoId: tpl.grupoId, tipoRegistro: tpl.tipo, datos: datosForm, datosExcel: datosExcel, adjunto: document.getElementById('reg-file').value.split('\\').pop()||null, estado: estadoInicial, asignadoEnFlujo: responsableAsignado, fecha: new Date().toLocaleString(), timestamp: Date.now() });

            // Generar Tarea Si Aplica
            if(tpl.flujoConfig.tipo === 'tarea') {
                await addDoc(collection(db, "am_tareas"), { registroPadreId: nuevoRegRef.id, asignadoA: responsableAsignado, motivo: r, prioridad: p, estadoTarea: 'Pendiente', fechaAsig: new Date().toLocaleDateString(), timestamp: Date.now() });
                showToast(`Datos guardados y Tarea enviada a ${responsableAsignado}`);
            } else if (tpl.flujoConfig.tipo === 'aprobacion') {
                showToast(`Enviado para aprobación a ${responsableAsignado}`);
            } else { showToast("Registro procesado correctamente."); }

            e.target.reset(); document.getElementById('dynamic-form').classList.add('d-none'); document.getElementById('reg-template-select').value=""; btn.disabled=false; btn.innerHTML='<i class="bi bi-send-check-fill me-2"></i> PROCESAR Y ENVIAR DATOS';
        });

        // ================= GESTIÓN MASTER / TAREAS =================
        window.completarTarea = async (tareaId) => { if(confirm("¿Dar por completada esta acción?")) await updateDoc(doc(db,"am_tareas",tareaId),{estadoTarea:'Completada'}); };
        window.cambiarEstadoReg = async (id, st) => await updateDoc(doc(db,"am_registros",id),{estado:st}); window.delReg = async (id) => { if(confirm("Alerta: ¿Borrar definitivamente?")) await deleteDoc(doc(db,"am_registros",id)); };

        // ================= SINCRONIZACIÓN REALTIME =================
        function startRealtimeListeners() {
            onSnapshot(collection(db, "am_grupos"), s => {
                cache.groups = s.docs.map(d=>({id:d.id,...d.data()}));
                document.getElementById('list-groups').innerHTML = cache.groups.map(g=>`<li class="list-group-item d-flex justify-content-between align-items-center"><span class="fw-bold"><i class="bi bi-folder-fill text-warning me-2"></i>${g.nombre} <small class="text-muted fw-normal">(${g.id})</small></span><i class="bi bi-trash text-danger pointer" onclick="delGroup('${g.id}')"></i></li>`).join('');
                document.getElementById('tpl-group').innerHTML = '<option value="">- Seleccionar -</option>' + cache.groups.map(g=>`<option value="${g.id}">${g.nombre}</option>`).join('');
                
                // Inyectar Checkboxes Mejorados (UX)
                document.getElementById('usr-groups-container').innerHTML = cache.groups.map(g => `<div class="col-6 col-md-4"><div class="group-checkbox-card border rounded-3 p-2 bg-white"><input class="form-check-input ms-1 me-2 grp-chk pointer" type="checkbox" value="${g.id}" id="chk-grp-${g.id}"><label class="form-check-label small pointer text-secondary" for="chk-grp-${g.id}">${g.nombre}</label></div></div>`).join('');
            });

            onSnapshot(collection(db, "am_usuarios"), s => {
                cache.users = s.docs.map(d=>({id:d.id,...d.data()}));
                document.getElementById('list-users').innerHTML = cache.users.map(u=>`<li class="list-group-item d-flex justify-content-between align-items-center"><div><div class="fw-bold text-dark"><i class="bi bi-person-circle text-primary me-2"></i>${u.id} <span class="badge bg-light text-primary border ms-1">${u.rol}</span></div><small class="text-muted"><i class="bi bi-diagram-2 ms-4 me-1"></i>${u.grupos?.join(', ')||'Sin grupos'}</small></div><i class="bi bi-trash text-danger pointer hover-scale" onclick="delUser('${u.id}')"></i></li>`).join('');
                document.getElementById('flow-fixed-user').innerHTML = '<option value="">- Seleccione al Usuario -</option>' + cache.users.map(u=>`<option value="${u.id}">${u.id} (${u.rol})</option>`).join('');
            });

            onSnapshot(collection(db, "am_plantillas"), s => {
                cache.templates = s.docs.map(d=>({id:d.id,...d.data()}));
                const ms = currentUser.rol==='admin'?cache.templates:cache.templates.filter(t=>(currentUser.grupos||[]).includes(t.grupoId));
                document.getElementById('reg-template-select').innerHTML = '<option value="">- SELECCIONE UN FORMATO DISPONIBLE -</option>' + ms.map(t=>`<option value="${t.id}">[${t.tipo.toUpperCase()}] ${t.nombre}</option>`).join('');
                document.getElementById('list-templates').innerHTML = cache.templates.map(t=>`<li class="list-group-item d-flex justify-content-between align-items-center bg-transparent"><div class="lh-sm"><span class="fw-bold text-dark d-block mb-1">${t.nombre}</span><span class="badge bg-secondary me-1">${t.tipo}</span><span class="badge bg-info text-dark me-1">${t.grupoId}</span><small class="text-primary fw-bold d-block mt-1"><i class="bi bi-arrow-return-right"></i> Flujo: ${t.flujoConfig.tipo}</small></div><i class="bi bi-trash text-danger pointer p-2 shadow-sm rounded-circle bg-white border" onclick="delTpl('${t.id}')"></i></li>`).join('');
            });

             // Escuchar Bandeja: Tareas asignadas O Aprobaciones pendientes si soy el asignado
             onSnapshot(collection(db, "am_tareas"), s => {
                const misTareas = s.docs.map(d=>({id:d.id,...d.data()})).filter(t => t.asignadoA === currentUser.id && t.estadoTarea === 'Pendiente');
                document.getElementById('dash-tasks').innerText = misTareas.length;
                document.getElementById('body-mistareas').innerHTML = misTareas.map(t=>`<tr><td class="ps-4"><span class="status-pill bg-${t.prioridad=='alta'?'danger text-white':(t.prioridad=='media'?'warning text-dark':'success text-white')} border">${t.prioridad}</span></td><td class="fw-bold text-dark">${t.motivo}<br><small class="text-muted fw-normal"><i class="bi bi-link-45deg"></i> ID Doc: ${t.registroPadreId.substring(0,6)}</small></td><td><span class="badge bg-light text-dark border">${t.fechaAsig}</span></td><td><span class="status-pill st-pendiente">PENDIENTE</span></td><td><button class="btn btn-sm btn-success fw-bold shadow-sm" onclick="completarTarea('${t.id}')"><i class="bi bi-check-all me-1"></i> Check</button></td></tr>`).join('') || '<tr><td colspan="5" class="text-center py-4 text-muted bg-light"><i class="bi bi-cup-hot fs-3 d-block mb-2"></i>No hay pendientes en su bandeja.</td></tr>';
             });

            onSnapshot(query(collection(db, "am_registros"), orderBy('timestamp', 'desc')), s => {
                document.getElementById('dash-total').innerText = s.size;
                document.getElementById('body-global').innerHTML = s.docs.map(d=>{
                    const r = d.data(); r.id = d.id;
                    let resumenStr = r.tipoRegistro==='excel'?`<span class="badge bg-dark">${r.datosExcel.length} Filas Cargadas</span>` : Object.keys(r.datos).slice(0,2).map(k=>`<span class="text-muted">${k}:</span> <b class="text-dark">${r.datos[k]}</b>`).join('<br>');
                    let stClass = r.estado.includes('Pendiente') ? 'st-pendiente' : (r.estado==='Aprobado'?'st-aprobado':(r.estado==='Rechazado'?'st-rechazado':'st-registrado'));
                    
                    let flujoAsignado = r.asignadoEnFlujo ? `<small class="d-block text-primary fw-bold mt-1"><i class="bi bi-person-gear"></i> ${r.asignadoEnFlujo}</small>` : '';

                    let acciones = '<span class="text-muted small">-</span>';
                    // Si el estado es Pendiente, y yo soy el asignado (o admin), muestro botones de Aprobar
                    if(r.estado.includes('Pendiente') && (currentUser.rol === 'admin' || currentUser.id === r.asignadoEnFlujo)){
                         acciones = `<div class="btn-group shadow-sm"><button class="btn btn-sm btn-success fw-bold" onclick="cambiarEstadoReg('${r.id}','Aprobado')">Aprobar</button><button class="btn btn-sm btn-danger fw-bold" onclick="cambiarEstadoReg('${r.id}','Rechazado')">Rechazar</button></div>`;
                    }
                    if(currentUser.rol === 'admin') acciones += `<button class="btn btn-sm text-danger ms-2" onclick="delReg('${r.id}')"><i class="bi bi-trash fs-5"></i></button>`;

                    return `<tr><td class="ps-4"><span class="badge bg-light text-secondary border">${r.fecha.split(' ')[0]}</span></td><td><span class="badge bg-primary bg-opacity-10 text-primary border">${r.tipoRegistro.substring(0,3).toUpperCase()}</span></td><td class="fw-bold text-slate-800"><small>${r.plantillaNombre}</small></td><td><span class="badge bg-dark bg-opacity-10 text-dark">${r.grupoId}</span></td><td class="small" style="max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${resumenStr}</td><td><span class="status-pill ${stClass}">${r.estado}</span>${flujoAsignado}</td><td>${acciones}</td></tr>`;
                }).join('');
            });
        }
        window.exportarTabla = (tId,n) => { const t=document.getElementById(tId); if(!t)return; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([`<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"></head><body><table border="1">${t.innerHTML}</table></body></html>`],{type:'application/vnd.ms-excel'})); a.download=`${n}.xls`; a.click(); };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
