<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArchiveMaster Pro - Registro de Datos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8f9fa; }
        .pointer { cursor: pointer; }
        .scroll-area { max-height: 400px; overflow-y: auto; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Badges de Estado */
        .estado-registrado { background-color: #e2e8f0; color: #475569; }
        .estado-revision { background-color: #fef3c7; color: #d97706; }
        .estado-aprobado { background-color: #d1fae5; color: #059669; }
        .estado-rechazado { background-color: #fee2e2; color: #dc2626; }
    </style>
</head>
<body>

    <div id="login-screen" class="container d-flex justify-content-center align-items-center vh-100">
        <div class="card p-4 shadow-lg border-0" style="width: 380px; background-color: #212529;">
            <h3 class="text-center text-primary fw-bold mb-4">ArchiveMaster</h3>
            <form id="login-form">
                <input type="text" id="login-user" class="form-control mb-3" placeholder="Usuario" required>
                <input type="password" id="login-pass" class="form-control mb-4" placeholder="Contraseña" required>
                <button type="submit" class="btn btn-primary w-100 fw-bold">INICIAR SESIÓN</button>
            </form>
        </div>
    </div>

    <div id="app-screen" class="d-none">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#"><i class="bi bi-box-seam"></i> ArchiveMaster</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navMain">
                    <ul class="navbar-nav me-auto" id="menu-dinamico">
                        </ul>
                    <div class="d-flex align-items-center gap-3">
                        <div class="text-white text-end lh-1">
                            <div id="user-display" class="fw-bold">Usuario</div>
                            <span id="role-display" class="badge bg-light text-primary text-uppercase mt-1" style="font-size: 0.65rem;">Rol</span>
                        </div>
                        <button class="btn btn-danger btn-sm" id="btn-logout" title="Cerrar Sesión"><i class="bi bi-power"></i></button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container mt-4 pb-5">
            
            <div id="sec-dashboard" class="content-section d-none">
                <h4 class="fw-bold text-secondary mb-3">Dashboard General</h4>
                <div class="row g-3 mb-4 text-center">
                    <div class="col-md-4"><div class="card p-4 shadow-sm border-start border-4 border-primary"><h2 id="dash-total">0</h2><small class="text-muted fw-bold text-uppercase">Total Registros</small></div></div>
                    <div class="col-md-4"><div class="card p-4 shadow-sm border-start border-4 border-success"><h2 id="dash-plantillas">0</h2><small class="text-muted fw-bold text-uppercase">Tipos de Formulario</small></div></div>
                    <div class="col-md-4"><div class="card p-4 shadow-sm border-start border-4 border-info"><h2 id="dash-users">0</h2><small class="text-muted fw-bold text-uppercase">Usuarios Activos</small></div></div>
                </div>
            </div>

            <div id="sec-registrar" class="content-section d-none">
                <div class="card shadow-sm border-0 mx-auto" style="max-width: 800px;">
                    <div class="card-header bg-white py-3 fw-bold text-primary border-bottom">Nuevo Registro</div>
                    <div class="card-body">
                        <label class="form-label small fw-bold text-muted">Seleccione el Tipo de Registro</label>
                        <select id="reg-template-select" class="form-select mb-4"></select>
                        
                        <form id="dynamic-upload-form" class="d-none">
                            <div id="dynamic-fields-container" class="row g-3"></div>
                            
                            <div class="mt-4 p-3 bg-light rounded border">
                                <label class="small fw-bold text-muted mb-2"><i class="bi bi-paperclip"></i> Archivo Adjunto (Excel, PDF, Imagen)</label>
                                <input type="file" id="reg-file" class="form-control">
                                <input type="hidden" id="reg-file-url">
                            </div>
                            
                            <button type="submit" class="btn btn-success w-100 mt-4 py-2 fw-bold"><i class="bi bi-cloud-arrow-up"></i> GUARDAR REGISTRO</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="sec-misregistros" class="content-section d-none">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3 fw-bold d-flex justify-content-between align-items-center border-bottom">
                        <span class="text-primary">Mis Registros</span>
                        <button class="btn btn-sm btn-outline-success" id="btn-export-mis"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                    </div>
                    <div class="card-body bg-light">
                        <div class="table-responsive bg-white rounded shadow-sm border">
                            <table class="table table-hover mb-0 align-middle" id="table-mis-registros">
                                <thead class="table-light text-muted small text-uppercase"><tr><th>Fecha</th><th>Tipo</th><th>Datos Principales</th><th>Adjunto</th><th>Estado</th></tr></thead>
                                <tbody id="body-mis-registros"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-admin" class="content-section d-none">
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="card shadow-sm border-0 h-100 p-4">
                            <h5 class="text-primary fw-bold mb-3"><i class="bi bi-ui-checks"></i> Tipos de Datos (Formularios)</h5>
                            <div class="bg-light p-3 rounded border mb-3">
                                <input type="text" id="tpl-name" class="form-control mb-3" placeholder="Nombre del Formulario (Ej. Carga de Excel, Inspección)">
                                
                                <div id="builder-fields" class="mb-3"></div>
                                
                                <div class="row g-2">
                                    <div class="col-5"><input type="text" id="new-field-name" class="form-control form-control-sm" placeholder="Nombre Campo"></div>
                                    <div class="col-4">
                                        <select id="new-field-type" class="form-select form-select-sm">
                                            <option value="text">Texto Corto</option>
                                            <option value="textarea">Texto Largo</option>
                                            <option value="number">Número</option>
                                            <option value="date">Fecha</option>
                                        </select>
                                    </div>
                                    <div class="col-3"><button class="btn btn-dark btn-sm w-100" id="btn-add-field">+ Añadir</button></div>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100 mb-4" id="btn-save-tpl">CREAR FORMULARIO</button>
                            <h6 class="fw-bold text-muted small mt-2">Formularios Activos</h6>
                            <ul id="list-templates" class="list-group list-group-flush scroll-area"></ul>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="card shadow-sm border-0 h-100 p-4">
                            <h5 class="text-primary fw-bold mb-3"><i class="bi bi-people"></i> Control de Usuarios</h5>
                            <form id="form-user" class="mb-4">
                                <div class="row g-2 mb-2">
                                    <div class="col-6"><input type="text" id="usr-id" class="form-control" placeholder="ID Usuario (Ej. perezj)" required></div>
                                    <div class="col-6"><input type="password" id="usr-pass" class="form-control" placeholder="Contraseña" required></div>
                                </div>
                                <div class="mb-3">
                                    <select id="usr-rol" class="form-select">
                                        <option value="usuario">Usuario Estándar</option>
                                        <option value="revisor">Revisor (Cambia Estados)</option>
                                        <option value="admin">Administrador Global</option>
                                    </select>
                                </div>
                                <div class="mb-3 border p-3 rounded bg-light">
                                    <label class="small fw-bold d-block text-muted mb-2">Permisos de Módulos:</label>
                                    <div class="form-check form-check-inline"><input class="form-check-input perm-chk" type="checkbox" value="dashboard" id="p-dash"><label class="form-check-label small" for="p-dash">Dashboard</label></div>
                                    <div class="form-check form-check-inline"><input class="form-check-input perm-chk" type="checkbox" value="registrar" id="p-reg" checked><label class="form-check-label small" for="p-reg">Registrar</label></div>
                                    <div class="form-check form-check-inline"><input class="form-check-input perm-chk" type="checkbox" value="misregistros" id="p-mis" checked><label class="form-check-label small" for="p-mis">Mis Reg</label></div>
                                    <div class="form-check form-check-inline"><input class="form-check-input perm-chk" type="checkbox" value="historial" id="p-hist"><label class="form-check-label small" for="p-hist">Historial Global</label></div>
                                    <div class="form-check form-check-inline"><input class="form-check-input perm-chk" type="checkbox" value="admin" id="p-adm"><label class="form-check-label small" for="p-adm">Admin</label></div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">GUARDAR USUARIO</button>
                            </form>
                            <ul id="list-users" class="list-group list-group-flush scroll-area border-top pt-2"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-historial" class="content-section d-none">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-dark text-white py-3 fw-bold d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-database"></i> Historial y Gestión General</span>
                        <button class="btn btn-sm btn-light text-dark" id="btn-export-global"><i class="bi bi-file-earmark-excel"></i> Descargar Reporte Completo</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="table-global">
                                <thead class="table-light text-muted small text-uppercase"><tr><th>Fecha</th><th>Usuario</th><th>Formulario</th><th>Adjunto</th><th>Estado</th><th>Gestión / Flujo</th></tr></thead>
                                <tbody id="body-global"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // CONFIGURACIÓN FIREBASE (Usa la tuya de app.js)
        const firebaseConfig = { 
            apiKey: "AIzaSyA3cRmakg2dV2YRuNV1fY7LE87artsLmB8", 
            authDomain: "mi-web-db.firebaseapp.com", 
            projectId: "mi-web-db", 
            storageBucket: "mi-web-db.appspot.com" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables Globales
        let usuarioActual = null;
        let camposTemporales = [];
        let plantillasCache = [];
        let registrosCache = [];

        // --- SISTEMA DE SESIÓN ---
        window.addEventListener('DOMContentLoaded', () => {
            const s = localStorage.getItem("archive_session");
            if(s) iniciarApp(JSON.parse(s));
            
            // Cloudinary Script (Opcional si usas el widget, lo simulamos con un texto por simplicidad o puedes reinyectar tu setup)
            // setupCloudinary(); 
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById("login-user").value.trim().toLowerCase();
            const p = document.getElementById("login-pass").value.trim();
            
            // Credenciales Admin por defecto
            if(u === "admin" && p === "1130") { 
                iniciarApp({ id: "admin", rol: "admin", accesos: ["dashboard", "registrar", "misregistros", "historial", "admin"] }); 
                return; 
            }

            try { 
                const s = await getDoc(doc(db, "am_usuarios", u)); 
                if(s.exists() && s.data().pass === p) {
                    iniciarApp({ id: u, ...s.data() }); 
                } else alert("Credenciales incorrectas"); 
            } catch(e) { alert("Error de red"); console.error(e); }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            localStorage.removeItem("archive_session"); location.reload();
        });

        function iniciarApp(userData) {
            usuarioActual = userData;
            localStorage.setItem("archive_session", JSON.stringify(userData));
            
            document.getElementById("login-screen").classList.add("d-none");
            document.getElementById("app-screen").classList.remove("d-none");
            
            document.getElementById("user-display").innerText = userData.id;
            document.getElementById("role-display").innerText = userData.rol;

            construirMenu(userData.accesos || []);
            
            // Mostrar la primera pestaña disponible
            if(userData.accesos.length > 0) verSeccion(userData.accesos[0]);
            
            activarListenersBD();
        }

        // --- NAVEGACIÓN Y MENÚ ---
        const seccionesDisp = {
            dashboard: { id: 'sec-dashboard', nom: 'Dashboard', icon: 'speedometer2' },
            registrar: { id: 'sec-registrar', nom: 'Registrar', icon: 'plus-circle' },
            misregistros: { id: 'sec-misregistros', nom: 'Mis Registros', icon: 'list-check' },
            historial: { id: 'sec-historial', nom: 'Historial', icon: 'database' },
            admin: { id: 'sec-admin', nom: 'Panel Admin', icon: 'gear' }
        };

        function construirMenu(accesos) {
            const menu = document.getElementById("menu-dinamico");
            menu.innerHTML = accesos.map(acc => {
                if(!seccionesDisp[acc]) return '';
                const s = seccionesDisp[acc];
                return `<li class="nav-item"><a class="nav-link pointer px-3" onclick="verSeccion('${acc}')"><i class="bi bi-${s.icon}"></i> ${s.nom}</a></li>`;
            }).join('');
        }

        window.verSeccion = (idSeccion) => {
            document.querySelectorAll(".content-section").forEach(el => el.classList.add("d-none"));
            document.getElementById(seccionesDisp[idSeccion].id).classList.remove("d-none");
        };

        // --- MOTOR DE FORMULARIOS (ADMIN) ---
        document.getElementById('btn-add-field').addEventListener('click', () => {
            const name = document.getElementById('new-field-name').value.trim();
            const type = document.getElementById('new-field-type').value;
            if(!name) return;
            camposTemporales.push({ name, type });
            renderBuilderFields();
            document.getElementById('new-field-name').value = '';
        });

        function renderBuilderFields() {
            const container = document.getElementById('builder-fields');
            container.innerHTML = camposTemporales.map((c, i) => `
                <div class="badge bg-white text-dark border p-2 me-2 mb-2">
                    ${c.name} <span class="text-muted small">(${c.type})</span>
                    <i class="bi bi-x-circle text-danger ms-2 pointer" onclick="removerCampo(${i})"></i>
                </div>
            `).join('');
        }

        window.removerCampo = (index) => { camposTemporales.splice(index, 1); renderBuilderFields(); };

        document.getElementById('btn-save-tpl').addEventListener('click', async () => {
            const name = document.getElementById('tpl-name').value.trim();
            if(!name || camposTemporales.length === 0) return alert("Ingrese nombre y al menos un campo.");
            
            await addDoc(collection(db, "am_plantillas"), { 
                nombre: name, campos: camposTemporales, fechaCreacion: Date.now() 
            });
            
            document.getElementById('tpl-name').value = '';
            camposTemporales = []; renderBuilderFields();
            alert("Plantilla creada.");
        });

        // --- REGISTRO DE DATOS (USUARIO) ---
        document.getElementById('reg-template-select').addEventListener('change', (e) => {
            const form = document.getElementById('dynamic-upload-form');
            const container = document.getElementById('dynamic-fields-container');
            const tplId = e.target.value;
            
            if(!tplId) { form.classList.add('d-none'); return; }
            
            const tpl = plantillasCache.find(p => p.id === tplId);
            form.classList.remove('d-none');
            
            container.innerHTML = tpl.campos.map(c => `
                <div class="${c.type === 'textarea' ? 'col-12' : 'col-md-6'}">
                    <label class="form-label small fw-bold text-muted">${c.name}</label>
                    ${c.type === 'textarea' ? `<textarea class="form-control dyn-field" data-name="${c.name}" required></textarea>` : `<input type="${c.type}" class="form-control dyn-field" data-name="${c.name}" required>`}
                </div>
            `).join('');
        });

        // Mock adjunto de archivo (Para que guarde sin Cloudinary estricto por ahora)
        document.getElementById('reg-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) document.getElementById('reg-file-url').value = file.name; // En un entorno real, subir a Storage y guardar URL
        });

        document.getElementById('dynamic-upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const tplId = document.getElementById('reg-template-select').value;
            const tpl = plantillasCache.find(p => p.id === tplId);
            
            let datos = {};
            document.querySelectorAll('.dyn-field').forEach(el => datos[el.dataset.name] = el.value);
            
            const adjunto = document.getElementById('reg-file-url').value || null;

            await addDoc(collection(db, "am_registros"), {
                usuarioId: usuarioActual.id,
                plantillaId: tplId,
                plantillaNombre: tpl.nombre,
                datos: datos,
                adjunto: adjunto,
                estado: "Registrado", // Flujo Inicial
                fecha: new Date().toLocaleString(),
                timestamp: Date.now()
            });

            alert("Registro exitoso.");
            e.target.reset(); document.getElementById('dynamic-upload-form').classList.add('d-none'); document.getElementById('reg-template-select').value = "";
        });

        // --- GESTIÓN DE USUARIOS ---
        document.getElementById('form-user').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('usr-id').value.trim().toLowerCase();
            const pass = document.getElementById('usr-pass').value.trim();
            const rol = document.getElementById('usr-rol').value;
            let accesos = [];
            document.querySelectorAll('.perm-chk:checked').forEach(chk => accesos.push(chk.value));

            await setDoc(doc(db, "am_usuarios", id), { pass, rol, accesos }, { merge: true });
            alert("Usuario guardado"); e.target.reset();
        });

        window.eliminarUsuario = async (id) => { if(confirm("¿Eliminar usuario?")) await deleteDoc(doc(db, "am_usuarios", id)); };
        window.eliminarPlantilla = async (id) => { if(confirm("¿Eliminar plantilla?")) await deleteDoc(doc(db, "am_plantillas", id)); };

        // --- FLUJO DE TRABAJO (ESTADOS) ---
        window.cambiarEstado = async (regId, nuevoEstado) => {
            await updateDoc(doc(db, "am_registros", regId), { estado: nuevoEstado });
        };

        window.eliminarRegistro = async (regId) => {
            if(confirm("¿Eliminar este registro permanentemente?")) await deleteDoc(doc(db, "am_registros", regId));
        };

        // --- SINCRONIZACIÓN EN TIEMPO REAL ---
        function activarListenersBD() {
            
            // Escuchar Plantillas
            onSnapshot(collection(db, "am_plantillas"), snap => {
                plantillasCache = [];
                const select = document.getElementById("reg-template-select");
                const lista = document.getElementById("list-templates");
                select.innerHTML = '<option value="">-- Seleccionar --</option>';
                lista.innerHTML = '';
                
                snap.forEach(doc => {
                    const d = doc.data(); d.id = doc.id; plantillasCache.push(d);
                    select.innerHTML += `<option value="${d.id}">${d.nombre}</option>`;
                    lista.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">${d.nombre} <button class="btn btn-sm btn-outline-danger" onclick="eliminarPlantilla('${d.id}')"><i class="bi bi-trash"></i></button></li>`;
                });
                
                if(document.getElementById("dash-plantillas")) document.getElementById("dash-plantillas").innerText = plantillasCache.length;
            });

            // Escuchar Usuarios (Solo si es admin)
            if(usuarioActual.rol === 'admin') {
                onSnapshot(collection(db, "am_usuarios"), snap => {
                    const l = document.getElementById("list-users"); l.innerHTML = '';
                    let c = 0;
                    snap.forEach(doc => {
                        const u = doc.data(); c++;
                        l.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            <div><strong>${doc.id}</strong> <span class="badge bg-secondary ms-2">${u.rol}</span></div>
                            <button class="btn btn-sm text-danger" onclick="eliminarUsuario('${doc.id}')"><i class="bi bi-trash"></i></button>
                        </li>`;
                    });
                    document.getElementById("dash-users").innerText = c + 1; // +1 por el admin quemado
                });
            }

            // Escuchar Registros
            onSnapshot(collection(db, "am_registros"), snap => {
                registrosCache = [];
                const tbodyMis = document.getElementById("body-mis-registros");
                const tbodyGlobal = document.getElementById("body-global");
                tbodyMis.innerHTML = ''; tbodyGlobal.innerHTML = '';

                let total = 0;

                snap.forEach(docSnap => {
                    const r = docSnap.data(); r.id = docSnap.id; registrosCache.push(r); total++;
                    
                    // Extraer primer dato para resumen
                    const claves = Object.keys(r.datos);
                    const resumenDato = claves.length > 0 ? `${claves[0]}: ${r.datos[claves[0]]}` : 'Sin datos';
                    const adj = r.adjunto ? `<i class="bi bi-paperclip text-primary"></i> ${r.adjunto}` : '-';
                    
                    const badgeClass = `estado-${r.estado.toLowerCase().replace('ó','o').replace(' ', '')}`;
                    const badgeHtml = `<span class="badge ${badgeClass} border px-2 py-1">${r.estado}</span>`;

                    // Llenar "Mis Registros"
                    if(r.usuarioId === usuarioActual.id) {
                        tbodyMis.innerHTML += `<tr>
                            <td><small>${r.fecha.split(',')[0]}</small></td>
                            <td class="fw-bold text-primary">${r.plantillaNombre}</td>
                            <td class="small text-muted">${resumenDato}</td>
                            <td><small>${adj}</small></td>
                            <td>${badgeHtml}</td>
                        </tr>`;
                    }

                    // Llenar "Historial Global" (Para Revisor/Admin)
                    if(['admin', 'revisor'].includes(usuarioActual.rol)) {
                        let acciones = '';
                        if(r.estado === 'Registrado') {
                            acciones = `<button class="btn btn-sm btn-outline-warning py-0 px-2 me-1" onclick="cambiarEstado('${r.id}', 'En Revisión')">Revisar</button>`;
                        } else if(r.estado === 'En Revisión') {
                            acciones = `<button class="btn btn-sm btn-outline-success py-0 px-2 me-1" onclick="cambiarEstado('${r.id}', 'Aprobado')">Aprobar</button>
                                        <button class="btn btn-sm btn-outline-danger py-0 px-2" onclick="cambiarEstado('${r.id}', 'Rechazado')">Rechazar</button>`;
                        }
                        
                        if(usuarioActual.rol === 'admin') {
                            acciones += `<button class="btn btn-sm text-danger ms-2 py-0 px-1" onclick="eliminarRegistro('${r.id}')" title="Eliminar"><i class="bi bi-trash"></i></button>`;
                        }

                        tbodyGlobal.innerHTML += `<tr>
                            <td><small>${r.fecha.split(',')[0]}</small></td>
                            <td class="fw-bold">${r.usuarioId}</td>
                            <td><span class="badge bg-light text-dark border">${r.plantillaNombre}</span></td>
                            <td><small>${adj}</small></td>
                            <td>${badgeHtml}</td>
                            <td>${acciones || '<span class="text-muted small">Sin acción</span>'}</td>
                        </tr>`;
                    }
                });
                
                if(document.getElementById("dash-total")) document.getElementById("dash-total").innerText = total;
            });
        }

        // --- EXPORTAR A EXCEL ---
        function exportarTabla(tableId, nombreArchivo) {
            const table = document.getElementById(tableId);
            if(!table) return;
            let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body><table border="1">${table.innerHTML}</table></body></html>`;
            const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${nombreArchivo}_${new Date().toISOString().slice(0,10)}.xls`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        document.getElementById('btn-export-mis').addEventListener('click', () => exportarTabla('table-mis-registros', 'MisRegistros'));
        document.getElementById('btn-export-global').addEventListener('click', () => exportarTabla('table-global', 'GlobalMaster'));

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
